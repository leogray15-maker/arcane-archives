<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Referrals & Rewards | The Arcane Archives</title>
    <link rel="icon" href="ArcaneA.png">
    <link rel="apple-touch-icon" href="ArcaneA.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #030303;
            --bg-secondary: #0a0a0a;
            --bg-card: #0f0f0f;
            --bg-elevated: #161616;
            --bg-hover: #1a1a1a;

            --purple: #8b5cf6;
            --purple-light: #a78bfa;
            --purple-dark: #7c3aed;
            --purple-glow: rgba(139, 92, 246, 0.4);

            --gold: #fbbf24;
            --gold-light: #fcd34d;
            --gold-dark: #d97706;
            --gold-glow: rgba(251, 191, 36, 0.4);

            --green: #22c55e;
            --green-light: #4ade80;
            --green-glow: rgba(34, 197, 94, 0.4);

            --blue: #3b82f6;
            --red: #ef4444;

            --text: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;

            --border: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========== ANIMATED BACKGROUND ========== */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 60% 40% at 50% -10%, rgba(34, 197, 94, 0.12), transparent),
                radial-gradient(ellipse 50% 30% at 90% 20%, rgba(251, 191, 36, 0.08), transparent),
                radial-gradient(ellipse 40% 30% at 10% 80%, rgba(139, 92, 246, 0.08), transparent),
                var(--bg-primary);
            pointer-events: none;
            z-index: 0;
        }

        /* ========== NAVIGATION ========== */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(64px + env(safe-area-inset-top, 0px));
            padding-top: env(safe-area-inset-top, 0px);
            background: rgba(3, 3, 3, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: max(1.5rem, env(safe-area-inset-left, 0px));
            padding-right: max(1.5rem, env(safe-area-inset-right, 0px));
        }

        .nav-back {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-back:hover {
            color: var(--text);
            background: var(--bg-elevated);
        }

        .nav-title {
            font-weight: 800;
            font-size: 0.875rem;
            background: linear-gradient(135deg, var(--green), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.02em;
        }

        .nav-badge {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--green);
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* ========== MAIN CONTENT ========== */
        .main {
            position: relative;
            z-index: 1;
            padding: calc(5rem + env(safe-area-inset-top, 0px)) max(1.5rem, env(safe-area-inset-right, 0px)) calc(4rem + env(safe-area-inset-bottom, 0px)) max(1.5rem, env(safe-area-inset-left, 0px));
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ========== HERO SECTION ========== */
        .hero {
            text-align: center;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }

        .hero-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 24px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(251, 191, 36, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .hero h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 900;
            margin-bottom: 1rem;
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        .hero h1 .amount {
            background: linear-gradient(135deg, var(--green), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            color: var(--text-secondary);
            font-size: 1.0625rem;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* ========== EARNINGS HIGHLIGHT ========== */
        .earnings-highlight {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .earnings-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--green), var(--gold), var(--green));
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .earnings-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--green);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .earnings-amount {
            font-size: clamp(3rem, 8vw, 4.5rem);
            font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--green), var(--green-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .earnings-period {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-4px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card.total::before { background: var(--purple); }
        .stat-card.active::before { background: var(--green); }
        .stat-card.pending::before { background: var(--gold); }
        .stat-card.rate::before { background: var(--blue); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
            line-height: 1;
        }

        .stat-value.purple { color: var(--purple-light); }
        .stat-value.green { color: var(--green); }
        .stat-value.gold { color: var(--gold); }
        .stat-value.blue { color: var(--blue); }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ========== REFERRAL LINK CARD ========== */
        .link-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .link-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .link-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .link-card-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .link-card-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .link-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .link-label {
            font-size: 0.6875rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.625rem;
        }

        .link-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .link-input {
            flex: 1;
            padding: 0.875rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
        }

        .copy-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 1.25rem;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--purple-glow);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, var(--green), #059669);
        }

        /* ========== SHARE BUTTONS ========== */
        .share-section {
            margin-top: 1.5rem;
        }

        .share-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .share-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text);
            font-size: 0.8125rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-btn:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .share-btn.twitter:hover { border-color: #1DA1F2; background: rgba(29, 161, 242, 0.1); }
        .share-btn.whatsapp:hover { border-color: #25D366; background: rgba(37, 211, 102, 0.1); }
        .share-btn.telegram:hover { border-color: #0088cc; background: rgba(0, 136, 204, 0.1); }

        /* ========== TABS ========== */
        .tabs-container {
            margin-bottom: 1.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.375rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.8125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== REFERRALS TABLE ========== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-title h2 {
            font-size: 1.0625rem;
            font-weight: 700;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            flex-shrink: 0;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 0 -0.5rem;
            padding: 0 0.5rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 0.875rem 1rem;
            color: var(--text-muted);
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .data-table tbody tr {
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: var(--bg-elevated);
        }

        .member-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--purple), var(--purple-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-badge.active {
            background: rgba(34, 197, 94, 0.1);
            color: var(--green);
        }

        .status-badge.pending {
            background: rgba(251, 191, 36, 0.1);
            color: var(--gold);
        }

        .status-badge.completed {
            background: rgba(34, 197, 94, 0.12);
            color: var(--green);
        }

        .status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .value-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--green);
        }

        .value-cell.pending {
            color: var(--text-muted);
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            border-radius: 16px;
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            opacity: 0.5;
        }

        .empty-state p {
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        /* ========== INFO BOX ========== */
        .info-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(139, 92, 246, 0.03));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .info-box h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--purple-light);
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .info-list {
            list-style: none;
            display: grid;
            gap: 0.625rem;
        }

        .info-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.625rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .info-list li::before {
            content: '‚Üí';
            color: var(--purple-light);
            font-weight: 700;
            flex-shrink: 0;
        }

        /* ========== EARNINGS TAB ========== */
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .balance-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .balance-card.highlight {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
            border-color: rgba(34, 197, 94, 0.3);
        }

        .balance-label {
            color: var(--text-muted);
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .balance-value {
            font-size: 1.5rem;
            font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
        }

        .balance-value.green { color: var(--green); }
        .balance-value.gold { color: var(--gold); }
        .balance-value.purple { color: var(--purple-light); }
        .balance-value.dim { color: var(--text-muted); }

        /* ========== PAYMENT METHODS ========== */
        .payment-section h3 {
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payment-method {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 1.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .payment-method:hover {
            border-color: var(--border-hover);
        }

        .payment-method.selected {
            border-color: var(--purple);
            background: rgba(139, 92, 246, 0.1);
        }

        .payment-method .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .payment-method .name {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .payment-method .desc {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .payment-details {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .payment-details.active {
            display: block;
        }

        /* ========== FORMS ========== */
        .form-grid {
            display: grid;
            gap: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            padding: 0.875rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.9375rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--green), #059669);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 0.5rem;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--green-glow);
        }

        .withdrawal-info {
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }

        .withdrawal-info ul {
            list-style: none;
            display: grid;
            gap: 0.375rem;
        }

        .withdrawal-info li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.8125rem;
        }

        .withdrawal-info li::before {
            content: '‚Ä¢';
            color: var(--gold);
        }

        /* ========== VANTAGE SECTION ========== */
        .vantage-cta {
            text-align: center;
            padding: 2rem;
        }

        .vantage-cta .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .vantage-cta h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .vantage-cta p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            font-size: 0.9375rem;
        }

        .vantage-cta .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border: none;
            border-radius: 10px;
            color: #000;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.2s;
        }

        .vantage-cta .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--gold-glow);
        }

        /* ========== MILESTONE PROGRESS ========== */
        .milestones {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .milestones-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .milestones-title {
            font-size: 0.9375rem;
            font-weight: 700;
        }

        .milestones-count {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .milestone-track {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .milestone-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 700;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .milestone-dot.achieved {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }

        .milestone-dot.current {
            background: var(--gold);
            border-color: var(--gold);
            color: #000;
            animation: pulseMilestone 2s ease-in-out infinite;
        }

        @keyframes pulseMilestone {
            0%, 100% { box-shadow: 0 0 0 0 var(--gold-glow); }
            50% { box-shadow: 0 0 0 8px transparent; }
        }

        .milestone-line {
            flex: 1;
            height: 2px;
            background: var(--border);
        }

        .milestone-line.achieved {
            background: var(--green);
        }

        .milestone-rewards {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .milestone-reward {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.875rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.75rem;
        }

        .milestone-reward.achieved {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: var(--green);
        }

        .milestone-reward.locked {
            opacity: 0.5;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .nav {
                padding-left: max(1rem, env(safe-area-inset-left, 0px));
                padding-right: max(1rem, env(safe-area-inset-right, 0px));
            }

            .nav-badge {
                display: none;
            }

            .main {
                padding: calc(4.5rem + env(safe-area-inset-top, 0px)) max(1rem, env(safe-area-inset-left, 0px)) calc(3rem + env(safe-area-inset-bottom, 0px));
            }

            .hero {
                padding: 2rem 0;
            }

            .hero-icon {
                width: 64px;
                height: 64px;
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .link-card {
                padding: 1.5rem;
            }

            .link-input-group {
                flex-direction: column;
            }

            .copy-btn {
                justify-content: center;
                padding: 0.875rem;
            }

            .share-buttons {
                justify-content: center;
            }

            .tabs {
                flex-direction: row;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.75rem;
            }

            .card {
                padding: 1.25rem;
            }

            .balance-grid {
                grid-template-columns: 1fr;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .milestone-track {
                flex-wrap: wrap;
                gap: 0.375rem;
            }

            .milestone-line {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .hero h1 {
                font-size: 1.75rem;
            }

            .earnings-amount {
                font-size: 2.5rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }
        }

    </style>
</head>
<body>

<!-- Background -->
<div class="bg-gradient"></div>

<!-- Navigation -->
<nav class="nav">
    <a href="dashboard.html" class="nav-back">‚Üê Back</a>
    <span class="nav-title">REFERRAL PROGRAM</span>
    <span class="nav-badge">Free Access</span>
</nav>

<main class="main">
    <!-- Hero -->
    <section class="hero">
        <div class="hero-icon">üí∞</div>
        <h1>Earn <span class="amount">¬£25/month</span> per referral</h1>
        <p class="hero-subtitle">Share your unique link and earn recurring monthly commissions for every active subscriber you refer.</p>
    </section>

    <!-- Earnings Highlight -->
    <div class="earnings-highlight">
        <div class="earnings-label">Your Monthly Earnings</div>
        <div class="earnings-amount" id="monthlyEarningsDisplay">¬£0</div>
        <div class="earnings-period">recurring every month</div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-value purple" id="totalReferrals">0</div>
            <div class="stat-label">Total Referrals</div>
        </div>
        <div class="stat-card active">
            <div class="stat-value green" id="activeMembers">0</div>
            <div class="stat-label">Active Members</div>
        </div>
        <div class="stat-card pending">
            <div class="stat-value gold" id="pendingReferrals">0</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card rate">
            <div class="stat-value blue" id="conversionRate">0%</div>
            <div class="stat-label">Conversion</div>
        </div>
    </div>

    <!-- Milestones -->
    <div class="milestones">
        <div class="milestones-header">
            <span class="milestones-title">üèÜ Referral Milestones</span>
            <span class="milestones-count" id="milestonesCount">0/5 unlocked</span>
        </div>
        <div class="milestone-track" id="milestoneTrack">
            <div class="milestone-dot" data-count="1">1</div>
            <div class="milestone-line"></div>
            <div class="milestone-dot" data-count="5">5</div>
            <div class="milestone-line"></div>
            <div class="milestone-dot" data-count="10">10</div>
            <div class="milestone-line"></div>
            <div class="milestone-dot" data-count="25">25</div>
            <div class="milestone-line"></div>
            <div class="milestone-dot" data-count="50">50</div>
        </div>
        <div class="milestone-rewards" id="milestoneRewards">
            <div class="milestone-reward locked" data-count="1">üéâ First Referral</div>
            <div class="milestone-reward locked" data-count="5">‚≠ê Rising Star</div>
            <div class="milestone-reward locked" data-count="10">üî• Top Affiliate</div>
            <div class="milestone-reward locked" data-count="25">üíé Diamond Status</div>
            <div class="milestone-reward locked" data-count="50">üëë Arcane Legend</div>
        </div>
    </div>

    <!-- Referral Link Card -->
    <div class="link-card">
        <div class="link-card-header">
            <div class="link-card-icon">üîó</div>
            <div>
                <div class="link-card-title">Your Referral Link</div>
                <div class="link-card-subtitle">Share & earn ¬£25/month per active subscriber</div>
            </div>
        </div>

        <div class="link-box">
            <div class="link-label">Copy Your Link</div>
            <div class="link-input-group">
                <input type="text" id="arcaneRefLink" readonly class="link-input" value="Loading..." />
                <button class="copy-btn" id="copyArcaneBtn">
                    <span>üìã</span>
                    <span>Copy Link</span>
                </button>
            </div>
        </div>

        <div class="share-section">
            <div class="share-label">Quick Share</div>
            <div class="share-buttons">
                <a href="#" class="share-btn twitter" id="shareTwitter">
                    <span>ùïè</span> Twitter
                </a>
                <a href="#" class="share-btn whatsapp" id="shareWhatsapp">
                    <span>üí¨</span> WhatsApp
                </a>
                <a href="#" class="share-btn telegram" id="shareTelegram">
                    <span>‚úàÔ∏è</span> Telegram
                </a>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="referrals">My Referrals</button>
            <button class="tab-btn" data-tab="earnings">Earnings & Withdraw</button>
            <button class="tab-btn" data-tab="vantage">Vantage Markets</button>
        </div>
    </div>

    <!-- Tab: Referrals -->
    <div id="referrals" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon" style="background: linear-gradient(135deg, var(--purple), var(--purple-dark));">üë•</div>
                    <h2>Referred Members</h2>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Joined</th>
                            <th>Status</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="referralsTableBody">
                        <tr>
                            <td colspan="4">
                                <div class="empty-state">
                                    <div class="empty-icon">üë•</div>
                                    <p>Loading referrals...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="info-box">
                <h3>üí° How It Works</h3>
                <ul class="info-list">
                    <li><strong>Per Member:</strong> Earn ¬£25/month for every active subscriber</li>
                    <li><strong>Recurring:</strong> Commissions paid monthly as long as they stay subscribed</li>
                    <li><strong>Minimum Withdrawal:</strong> ¬£50</li>
                    <li><strong>Processing:</strong> Withdrawals processed twice weekly (Mon & Thu)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Tab: Earnings -->
    <div id="earnings" class="tab-content">
        <div class="balance-grid">
            <div class="balance-card highlight">
                <div class="balance-label">Available to Withdraw</div>
                <div class="balance-value green" id="availableBalance">¬£0.00</div>
            </div>
            <div class="balance-card">
                <div class="balance-label">Pending Earnings</div>
                <div class="balance-value gold" id="pendingBalance">¬£0.00</div>
            </div>
            <div class="balance-card">
                <div class="balance-label">Total Earned</div>
                <div class="balance-value purple" id="totalEarned">¬£0.00</div>
            </div>
            <div class="balance-card">
                <div class="balance-label">Total Withdrawn</div>
                <div class="balance-value dim" id="totalWithdrawn">¬£0.00</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon" style="background: linear-gradient(135deg, var(--green), #059669);">üí∏</div>
                    <h2>Request Withdrawal</h2>
                </div>
            </div>

            <div class="withdrawal-info">
                <ul>
                    <li>Minimum withdrawal: ¬£50.00</li>
                    <li>Processing time: 24-48 hours</li>
                    <li>Payments via bank transfer or crypto</li>
                </ul>
            </div>

            <div class="payment-section">
                <h3>Select Payment Method</h3>
                <div class="payment-methods">
                    <div class="payment-method" data-method="bank">
                        <div class="icon">üè¶</div>
                        <div class="name">Bank Transfer</div>
                        <div class="desc">UK/EU banks</div>
                    </div>
                    <div class="payment-method" data-method="crypto">
                        <div class="icon">‚Çø</div>
                        <div class="name">Crypto</div>
                        <div class="desc">BTC/ETH/USDT</div>
                    </div>
                </div>

                <!-- Bank Form -->
                <div class="payment-details" id="bankDetails">
                    <form id="bankForm" class="form-grid">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Account Holder Name</label>
                                <input type="text" id="accountName" required>
                            </div>
                            <div class="form-group">
                                <label>Bank Name</label>
                                <input type="text" id="bankName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Account Number</label>
                                <input type="text" id="accountNumber" required>
                            </div>
                            <div class="form-group">
                                <label>Sort Code</label>
                                <input type="text" id="sortCode" placeholder="XX-XX-XX" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Withdrawal Amount (¬£)</label>
                            <input type="number" id="bankAmount" min="50" step="0.01" required>
                        </div>
                        <button type="submit" class="btn-submit">Request Withdrawal</button>
                    </form>
                </div>

                <!-- Crypto Form -->
                <div class="payment-details" id="cryptoDetails">
                    <form id="cryptoForm" class="form-grid">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cryptocurrency</label>
                                <select id="cryptoType">
                                    <option value="BTC">Bitcoin (BTC)</option>
                                    <option value="ETH">Ethereum (ETH)</option>
                                    <option value="USDT">Tether (USDT)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Network</label>
                                <select id="cryptoNetwork">
                                    <option value="mainnet">Mainnet</option>
                                    <option value="erc20">ERC-20</option>
                                    <option value="trc20">TRC-20</option>
                                    <option value="bep20">BEP-20</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Wallet Address</label>
                            <input type="text" id="walletAddress" required>
                        </div>
                        <div class="form-group">
                            <label>Withdrawal Amount (¬£)</label>
                            <input type="number" id="cryptoAmount" min="50" step="0.01" required>
                        </div>
                        <button type="submit" class="btn-submit">Request Withdrawal</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Withdrawal History -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon" style="background: linear-gradient(135deg, var(--blue), #2563eb);">üìú</div>
                    <h2>Withdrawal History</h2>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalHistoryBody">
                        <tr>
                            <td colspan="4">
                                <div class="empty-state">
                                    <div class="empty-icon">üìú</div>
                                    <p>No withdrawals yet</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tab: Vantage -->
    <div id="vantage" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-icon" style="background: linear-gradient(135deg, var(--gold), var(--gold-dark));">üè¶</div>
                    <h2>Vantage Markets Referrals</h2>
                </div>
            </div>

            <div id="vantageContent">
                <div class="vantage-cta">
                    <div class="icon">üè¶</div>
                    <h3>Vantage Markets Not Connected</h3>
                    <p>Connect your Vantage Markets account to unlock unlimited earning potential through trading rebates.</p>
                    <a href="settings.html" class="btn">‚öôÔ∏è Connect in Settings</a>
                </div>
            </div>
        </div>
    </div>
</main>

<script type="module">
    import { checkAuth, db } from './auth-guard.js';
    import {
        doc,
        getDoc,
        collection,
        query,
        where,
        limit,
        setDoc,
        serverTimestamp,
        getDocs
    } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

    let currentUser = null;
    let referralLink = '';

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'earnings') {
                loadAffiliateEarnings();
                loadWithdrawalHistory();
            }
        });
    });

    // Payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            const methodType = method.dataset.method;

            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
            method.classList.add('selected');

            document.querySelectorAll('.payment-details').forEach(detail => {
                detail.classList.remove('active');
            });
            document.getElementById(methodType + 'Details').classList.add('active');
        });
    });

    // Auth check
    checkAuth(async (user, userData) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        currentUser = user;

        const referralCode = userData?.referralCode || user.uid.slice(0, 8).toUpperCase();
        referralLink = `https://arcanearchives.shop/?ref=${referralCode}`;

        document.getElementById('arcaneRefLink').value = referralLink;

        // Setup share buttons
        setupShareButtons();

        await loadReferralStats(referralCode);
        await loadVantageSection(userData || {});
        loadReferredMembers(referralCode);
    });

    function setupShareButtons() {
        const message = `Join The Arcane Archives - 3,330+ modules on trading, business, health & more. Use my link: ${referralLink}`;

        document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
        document.getElementById('shareWhatsapp').href = `https://wa.me/?text=${encodeURIComponent(message)}`;
        document.getElementById('shareTelegram').href = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent('Join The Arcane Archives!')}`;
    }

    // Copy referral link ‚Äî with mobile-safe clipboard fallback
    function copyToClipboard(text, btn, successLabel, originalLabel) {
        const doSuccess = () => {
            btn.innerHTML = `<span>‚úÖ</span><span>${successLabel}</span>`;
            btn.classList.add('copied');
            setTimeout(() => {
                btn.innerHTML = `<span>üìã</span><span>${originalLabel}</span>`;
                btn.classList.remove('copied');
            }, 2000);
        };
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(doSuccess).catch(() => {
                // Fallback for older/mobile browsers
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                ta.setSelectionRange(0, 99999);
                try { document.execCommand('copy'); doSuccess(); } catch(e) {}
                document.body.removeChild(ta);
            });
        } else {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            ta.setSelectionRange(0, 99999);
            try { document.execCommand('copy'); doSuccess(); } catch(e) {}
            document.body.removeChild(ta);
        }
    }

    document.getElementById('copyArcaneBtn').addEventListener('click', () => {
        const input = document.getElementById('arcaneRefLink');
        copyToClipboard(input.value, document.getElementById('copyArcaneBtn'), 'Copied!', 'Copy Link');
    });

    async function loadReferralStats(referralCode) {
        try {
            const usersRef = collection(db, 'Users');
            const q = query(usersRef, where('referredBy', '==', referralCode));
            const querySnapshot = await getDocs(q);

            let total = querySnapshot.size;
            let active = 0;

            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                if (userData.isPaid === true || userData.subscriptionStatus === 'active') {
                    active++;
                }
            });

            const pending = total - active;
            const monthlyEarnings = active * 25;
            const conversion = total > 0 ? Math.round((active / total) * 100) : 0;

            document.getElementById('totalReferrals').textContent = total;
            document.getElementById('activeMembers').textContent = active;
            document.getElementById('pendingReferrals').textContent = pending;
            document.getElementById('monthlyEarningsDisplay').textContent = `¬£${monthlyEarnings}`;
            document.getElementById('conversionRate').textContent = `${conversion}%`;

            // Update milestones
            updateMilestones(active);

        } catch (error) {
            console.error('Error loading referral stats:', error);
        }
    }

    function updateMilestones(activeCount) {
        const milestones = [1, 5, 10, 25, 50];
        let achieved = 0;

        milestones.forEach((count, index) => {
            const dot = document.querySelector(`.milestone-dot[data-count="${count}"]`);
            const reward = document.querySelector(`.milestone-reward[data-count="${count}"]`);
            const line = document.querySelectorAll('.milestone-line')[index];

            if (activeCount >= count) {
                dot?.classList.add('achieved');
                reward?.classList.remove('locked');
                reward?.classList.add('achieved');
                line?.classList.add('achieved');
                achieved++;
            } else if (activeCount > milestones[index - 1] || (index === 0 && activeCount >= 0)) {
                if (activeCount < count && (index === 0 || activeCount >= milestones[index - 1])) {
                    dot?.classList.add('current');
                }
            }
        });

        document.getElementById('milestonesCount').textContent = `${achieved}/5 unlocked`;
    }

    async function loadReferredMembers(referralCode) {
        try {
            const tbody = document.getElementById('referralsTableBody');

            const usersRef = collection(db, 'Users');
            const q = query(usersRef, where('referredBy', '==', referralCode));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-icon">üë•</div>
                                <p>No referrals yet. Share your link to get started!</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const referrals = [];
            querySnapshot.forEach((doc) => {
                referrals.push({ id: doc.id, ...doc.data() });
            });

            referrals.sort((a, b) => {
                const aTime = a.joinedAt?.toMillis ? a.joinedAt.toMillis() : 0;
                const bTime = b.joinedAt?.toMillis ? b.joinedAt.toMillis() : 0;
                return bTime - aTime;
            });

            tbody.innerHTML = '';

            referrals.forEach((userData) => {
                const isActive = userData.isPaid === true || userData.subscriptionStatus === 'active';
                const status = isActive ? 'active' : 'pending';
                const monthlyValue = isActive ? '¬£25' : '¬£0';
                const username = userData.Username || userData.Email?.split('@')[0] || 'New Member';
                const initial = username.charAt(0).toUpperCase();

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="member-cell">
                            <div class="member-avatar">${initial}</div>
                            <span>${escapeHtml(username)}</span>
                        </div>
                    </td>
                    <td>${formatDate(userData.joinedAt)}</td>
                    <td><span class="status-badge ${status}">${isActive ? 'Active' : 'Pending'}</span></td>
                    <td class="value-cell ${isActive ? '' : 'pending'}">${monthlyValue}/mo</td>
                `;

                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading referrals:', error);
        }
    }

    async function loadVantageSection(userData) {
        const vantageContent = document.getElementById('vantageContent');

        if (userData.vantageIBLink) {
            vantageContent.innerHTML = `
                <div class="link-box">
                    <div class="link-label">Your Sub-IB Link</div>
                    <div class="link-input-group">
                        <input type="text" id="vantageLinkDisplay" readonly value="${escapeHtml(userData.vantageIBLink)}" class="link-input" />
                        <button class="copy-btn" id="copyVantageBtn">
                            <span>üìã</span>
                            <span>Copy</span>
                        </button>
                    </div>
                </div>

                <div class="info-box" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.08), rgba(251, 191, 36, 0.03)); border-color: rgba(251, 191, 36, 0.2);">
                    <h3 style="color: var(--gold);">üí° How Vantage Markets Works</h3>
                    <ul class="info-list">
                        <li><strong>Your Commission:</strong> Earn rebates on trades from your direct referrals</li>
                        <li><strong>Override:</strong> Earn additional rebates from your Sub-IBs</li>
                        <li><strong>Payment:</strong> Vantage Markets pays you DIRECTLY monthly</li>
                    </ul>
                </div>
            `;

            document.getElementById('copyVantageBtn').addEventListener('click', () => {
                const input = document.getElementById('vantageLinkDisplay');
                copyToClipboard(input.value, document.getElementById('copyVantageBtn'), 'Copied!', 'Copy');
            });
        }
    }

    async function loadAffiliateEarnings() {
        try {
            const affiliateDoc = await getDoc(doc(db, 'Affiliates', currentUser.uid));

            if (affiliateDoc.exists()) {
                const data = affiliateDoc.data();
                document.getElementById('availableBalance').textContent = `¬£${(data.availableBalance || 0).toFixed(2)}`;
                document.getElementById('pendingBalance').textContent = `¬£${(data.pendingBalance || 0).toFixed(2)}`;
                document.getElementById('totalEarned').textContent = `¬£${(data.totalEarnings || 0).toFixed(2)}`;
                document.getElementById('totalWithdrawn').textContent = `¬£${(data.totalWithdrawn || 0).toFixed(2)}`;
            }
        } catch (error) {
            console.error('Error loading affiliate earnings:', error);
        }
    }

    async function loadWithdrawalHistory() {
        try {
            const q = query(
                collection(db, 'WithdrawalRequests'),
                where('userId', '==', currentUser.uid),
                limit(10)
            );

            const snapshot = await getDocs(q);
            const tbody = document.getElementById('withdrawalHistoryBody');

            if (snapshot.empty) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-icon">üìú</div>
                                <p>No withdrawals yet</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const withdrawals = [];
            snapshot.forEach((docSnap) => {
                withdrawals.push(docSnap.data());
            });

            withdrawals.sort((a, b) => {
                const aTime = a.createdAt?.toMillis() || 0;
                const bTime = b.createdAt?.toMillis() || 0;
                return bTime - aTime;
            });

            tbody.innerHTML = '';

            withdrawals.forEach((data) => {
                const statusLabel = {
                    pending: '‚è≥ Pending',
                    approved: '‚úÖ Approved',
                    completed: 'üíö Paid',
                    rejected: '‚ùå Rejected'
                }[data.status] || capitalizeFirst(data.status);

                const statusCss = {
                    pending: 'pending',
                    approved: 'pending',
                    completed: 'completed',
                    rejected: 'rejected'
                }[data.status] || data.status;

                const refNote = data.paymentRef
                    ? `<br/><small style="color:#22c55e;font-size:0.7rem;">Ref: ${escapeHtml(data.paymentRef)}</small>`
                    : '';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(data.createdAt)}</td>
                    <td class="value-cell">¬£${data.amount.toFixed(2)}</td>
                    <td>${data.method === 'bank' ? 'üè¶ Bank' : '‚Çø Crypto'}</td>
                    <td><span class="status-badge ${statusCss}">${statusLabel}</span>${refNote}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading withdrawal history:', error);
        }
    }

    // Shared withdrawal guard ‚Äî checks balance + no duplicate pending request
    async function canSubmitWithdrawal(amount) {
        // 1. Check available balance
        const affiliateDoc = await getDoc(doc(db, 'Affiliates', currentUser.uid));
        const available = affiliateDoc.exists() ? (affiliateDoc.data().availableBalance || 0) : 0;
        if (amount > available) {
            alert(`‚ùå Insufficient balance.\n\nYou have ¬£${available.toFixed(2)} available but requested ¬£${amount.toFixed(2)}.\n\nNote: pending earnings must clear first before they can be withdrawn.`);
            return false;
        }
        // 2. Check for existing pending/approved request
        const existingQ = query(
            collection(db, 'WithdrawalRequests'),
            where('userId', '==', currentUser.uid),
            where('status', 'in', ['pending', 'approved'])
        );
        const existingSnap = await getDocs(existingQ);
        if (!existingSnap.empty) {
            alert('‚è≥ You already have a withdrawal request being processed.\n\nPlease wait for it to be completed before submitting a new one.');
            return false;
        }
        return true;
    }

    // Bank form submission
    document.getElementById('bankForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]') || e.target.querySelector('button');
        const amount = parseFloat(document.getElementById('bankAmount').value);

        if (isNaN(amount) || amount < 50) {
            alert('Minimum withdrawal is ¬£50');
            return;
        }

        if (btn) { btn.disabled = true; btn.textContent = 'Submitting...'; }

        try {
            if (!(await canSubmitWithdrawal(amount))) {
                if (btn) { btn.disabled = false; btn.textContent = 'Request Withdrawal'; }
                return;
            }

            const withdrawalRef = doc(collection(db, 'WithdrawalRequests'));
            await setDoc(withdrawalRef, {
                userId: currentUser.uid,
                amount: amount,
                method: 'bank',
                accountName: document.getElementById('accountName').value.trim(),
                bankName: document.getElementById('bankName').value.trim(),
                accountNumber: document.getElementById('accountNumber').value.trim(),
                sortCode: document.getElementById('sortCode').value.trim(),
                status: 'pending',
                createdAt: serverTimestamp()
            });

            alert('‚úÖ Withdrawal request submitted! We\'ll process it within 24-48 hours.');
            document.getElementById('bankForm').reset();
            loadWithdrawalHistory();
            loadAffiliateEarnings();
        } catch (error) {
            console.error('Withdrawal error:', error);
            alert('‚ùå Failed to submit. Please try again.');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'Request Withdrawal'; }
        }
    });

    // Crypto form submission
    document.getElementById('cryptoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]') || e.target.querySelector('button');
        const amount = parseFloat(document.getElementById('cryptoAmount').value);

        if (isNaN(amount) || amount < 50) {
            alert('Minimum withdrawal is ¬£50');
            return;
        }

        if (btn) { btn.disabled = true; btn.textContent = 'Submitting...'; }

        try {
            if (!(await canSubmitWithdrawal(amount))) {
                if (btn) { btn.disabled = false; btn.textContent = 'Request Withdrawal'; }
                return;
            }

            const withdrawalRef = doc(collection(db, 'WithdrawalRequests'));
            await setDoc(withdrawalRef, {
                userId: currentUser.uid,
                amount: amount,
                method: 'crypto',
                cryptoType: document.getElementById('cryptoType').value,
                walletAddress: document.getElementById('walletAddress').value.trim(),
                network: document.getElementById('cryptoNetwork').value,
                status: 'pending',
                createdAt: serverTimestamp()
            });

            alert('‚úÖ Withdrawal request submitted! We\'ll process it within 24-48 hours.');
            document.getElementById('cryptoForm').reset();
            loadWithdrawalHistory();
            loadAffiliateEarnings();
        } catch (error) {
            console.error('Withdrawal error:', error);
            alert('‚ùå Failed to submit. Please try again.');
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'Request Withdrawal'; }
        }
    });

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    function capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
</script>
</body>
</html>
