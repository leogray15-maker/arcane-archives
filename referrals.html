<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Referrals & Rewards | The Arcane Archives</title>
    <link rel="icon" href="ArcaneA.png">
    <link rel="apple-touch-icon" href="ArcaneA.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ArcaneA.png">
    <meta name="apple-mobile-web-app-title" content="Arcane Archives">
    
    <style>
        :root {
            --bg-dark: #02010a;
            --bg-card: rgba(15, 23, 42, 0.96);
            --purple: #9333ea;
            --purple-dark: #7e22ce;
            --purple-light: #a78bfa;
            --gold: #fbbf24;
            --green: #22c55e;
            --text-light: #e5e5e5;
            --text-dim: #9ca3af;
            --border-color: rgba(148, 163, 184, 0.5);
            --red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
            background: radial-gradient(circle at top, #111827 0, #02010a 45%, #000 100%);
            color: var(--text-light);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
        }

        .back-btn {
            position: fixed;
            top: calc(1.5rem + env(safe-area-inset-top, 0));
            left: 1.5rem;
            z-index: 40;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.85rem;
            backdrop-filter: blur(12px);
        }

        .header {
            max-width: 1200px;
            margin: 2.5rem auto 0;
            padding: 1.5rem 1.5rem 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            font-size: 0.9rem;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto 4rem;
            padding: 0 1.5rem;
        }

        .page-hero {
            text-align: center;
            margin: 2rem 0;
        }

        .page-hero h1 {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, var(--purple-light), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-hero p {
            color: var(--text-dim);
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--purple-light);
            border-bottom-color: var(--purple);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .section-card h2 {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            color: var(--purple-light);
        }

        .section-subtitle {
            color: var(--text-dim);
            margin-bottom: 2rem;
        }

        .link-box {
            margin: 2rem 0;
        }

        .link-box label {
            display: block;
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .link-display {
            display: flex;
            gap: 0.5rem;
        }

        .link-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .copy-btn {
            padding: 0.75rem 1.5rem;
            background: var(--purple);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card .label {
            color: var(--text-dim);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-box {
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .info-box h3 {
            color: var(--purple-light);
            margin-bottom: 1rem;
        }

        .info-box ul {
            margin-left: 1.5rem;
            line-height: 1.8;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 2rem 0;
        }

        .referrals-table {
            width: 100%;
            border-collapse: collapse;
        }

        .referrals-table th {
            text-align: left;
            padding: 1rem;
            color: var(--text-dim);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
        }

        .referrals-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .status-badge.pending {
            background: rgba(251, 191, 36, 0.2);
            color: var(--gold);
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .payment-method {
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .payment-method.selected {
            border-color: var(--purple);
            background: rgba(147, 51, 234, 0.2);
        }

        .payment-method .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .payment-details {
            display: none;
            margin-top: 2rem;
        }

        .payment-details.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
        }

        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: var(--purple);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-top: 1rem;
        }

        .withdrawal-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .withdrawal-info ul {
            margin-left: 1.5rem;
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            .page-hero h1 {
                font-size: 2rem;
            }

            .tabs {
                gap: 0.5rem;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .section-card {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .link-display {
                flex-direction: column;
            }

            .copy-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="dashboard.html" class="back-btn">‚Üê Back</a>

    <div class="header">
        <div class="logo">
            <span>THE ARCANE ARCHIVES</span>
        </div>
    </div>

    <div class="main-content">
        <div class="page-hero">
            <h1>üí∞ Referrals & Rewards</h1>
            <p>Earn ¬£25/month for every active referral + trade rebates from Vantage Markets</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="program">Referral Program</button>
            <button class="tab-btn" data-tab="earnings">Affiliate Earnings</button>
        </div>

        <div id="program" class="tab-content active">
            
            <div class="section-card">
                <h2>üîó Arcane Archives Referrals</h2>
                <p class="section-subtitle">Earn ¬£25/month for every active member you refer</p>

                <div class="link-box">
                    <label>Your Referral Link</label>
                    <div class="link-display">
                        <input 
                            type="text" 
                            id="arcaneRefLink" 
                            readonly 
                            class="link-input"
                        />
                        <button class="copy-btn" id="copyArcaneBtn">üìã Copy</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="totalReferrals">0</div>
                        <div class="label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" style="color: var(--green);" id="activeMembers">0</div>
                        <div class="label">Active Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" style="color: var(--gold);" id="pendingReferrals">0</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" style="color: var(--purple-light);" id="monthlyEarnings">¬£0</div>
                        <div class="label">Monthly Earnings</div>
                    </div>
                </div>

                <h3 style="color: var(--purple-light); margin: 2rem 0 1rem 0; font-size: 1.3rem;">üë• Your Referrals</h3>
                <div class="table-wrapper">
                    <table class="referrals-table">
                        <thead>
                            <tr>
                                <th>Joined</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="referralsTableBody">
                            <tr>
                                <td colspan="4" style="text-align:center;color:var(--text-dim);">
                                    Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="info-box">
                    <h3>üí° How It Works</h3>
                    <ul>
                        <li><strong>Per Member:</strong> Earn ¬£25/month per active subscriber</li>
                        <li><strong>Payment Schedule:</strong> Monthly recurring commissions</li>
                        <li><strong>Minimum Withdrawal:</strong> ¬£50</li>
                        <li><strong>Processing:</strong> Withdrawals processed twice weekly (Mon & Thu)</li>
                        <li><strong>Withdraw:</strong> Go to "Affiliate Earnings" tab to request withdrawals</li>
                    </ul>
                </div>
            </div>

            <div class="section-card">
                <h2>üè¶ Vantage Markets Trading Referrals</h2>
                <p class="section-subtitle">Earn commission on trading volume (paid directly by Vantage Markets)</p>

                <div id="vantageContent"></div>
            </div>
        </div>

        <div id="earnings" class="tab-content">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" style="color: var(--green);" id="availableBalance">¬£0.00</div>
                    <div class="label">Available to Withdraw</div>
                </div>
                <div class="stat-card">
                    <div class="number" style="color: var(--gold);" id="pendingBalance">¬£0.00</div>
                    <div class="label">Pending Earnings</div>
                </div>
                <div class="stat-card">
                    <div class="number" style="color: var(--purple-light);" id="totalEarned">¬£0.00</div>
                    <div class="label">Total Earned</div>
                </div>
                <div class="stat-card">
                    <div class="number" style="color: var(--text-dim);" id="totalWithdrawn">¬£0.00</div>
                    <div class="label">Total Withdrawn</div>
                </div>
            </div>

            <div class="section-card">
                <h2>üí∏ Request Withdrawal</h2>
                
                <div class="withdrawal-info">
                    <ul>
                        <li>Minimum withdrawal: ¬£50.00</li>
                        <li>Processing time: 24-48 hours</li>
                        <li>Payments via bank transfer or crypto (BTC/ETH/USDT)</li>
                        <li>Withdrawals processed twice weekly (Mon & Thu)</li>
                    </ul>
                </div>

                <div class="payment-methods">
                    <div class="payment-method" data-method="bank">
                        <div class="icon">üè¶</div>
                        <div class="name">Bank Transfer</div>
                        <div class="description">UK/EU banks</div>
                    </div>
                    <div class="payment-method" data-method="crypto">
                        <div class="icon">‚Çø</div>
                        <div class="name">Crypto</div>
                        <div class="description">BTC/ETH/USDT</div>
                    </div>
                </div>

                <div class="payment-details" id="bankDetails">
                    <form id="bankForm">
                        <div class="form-group">
                            <label>Account Holder Name</label>
                            <input type="text" id="accountName" required>
                        </div>
                        <div class="form-group">
                            <label>Bank Name</label>
                            <input type="text" id="bankName" required>
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="text" id="accountNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Sort Code</label>
                            <input type="text" id="sortCode" placeholder="XX-XX-XX" required>
                        </div>
                        <div class="form-group">
                            <label>Withdrawal Amount (¬£)</label>
                            <input type="number" id="bankAmount" min="50" step="0.01" required>
                        </div>
                        <button type="submit" class="btn-submit">Submit Withdrawal Request</button>
                    </form>
                </div>

                <div class="payment-details" id="cryptoDetails">
                    <form id="cryptoForm">
                        <div class="form-group">
                            <label>Cryptocurrency</label>
                            <select id="cryptoType">
                                <option value="BTC">Bitcoin (BTC)</option>
                                <option value="ETH">Ethereum (ETH)</option>
                                <option value="USDT">Tether (USDT)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Wallet Address</label>
                            <input type="text" id="walletAddress" required>
                        </div>
                        <div class="form-group">
                            <label>Network</label>
                            <select id="cryptoNetwork">
                                <option value="mainnet">Mainnet</option>
                                <option value="erc20">ERC-20 (Ethereum)</option>
                                <option value="trc20">TRC-20 (Tron)</option>
                                <option value="bep20">BEP-20 (BSC)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Withdrawal Amount (¬£)</label>
                            <input type="number" id="cryptoAmount" min="50" step="0.01" required>
                        </div>
                        <button type="submit" class="btn-submit">Submit Withdrawal Request</button>
                    </form>
                </div>
            </div>

            <div class="section-card">
                <h2>üìú Withdrawal History</h2>
                <div class="table-wrapper">
                    <table class="referrals-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalHistoryBody">
                            <tr>
                                <td colspan="4" style="text-align:center;color:var(--text-dim);">
                                    No withdrawals yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            getDoc,
            collection,
            query,
            where,
            limit,
            onSnapshot,
            setDoc,
            serverTimestamp,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
            authDomain: "arcane-archives-3b0f5.firebaseapp.com",
            projectId: "arcane-archives-3b0f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                if (tabName === 'earnings') {
                    loadAffiliateEarnings();
                    loadWithdrawalHistory();
                }
            });
        });

        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', () => {
                const methodType = method.dataset.method;
                
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                method.classList.add('selected');
                
                document.querySelectorAll('.payment-details').forEach(detail => {
                    detail.classList.remove('active');
                });
                document.getElementById(methodType + 'Details').classList.add('active');
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;
            
            const userDoc = await getDoc(doc(db, 'Users', user.uid));
            const userData = userDoc.data();
            
            const referralCode = userData.referralCode || user.uid.slice(0, 8).toUpperCase();
            const arcaneRefLink = `https://arcanearchives.netlify.app/?ref=${referralCode}`;
            
            document.getElementById('arcaneRefLink').value = arcaneRefLink;
            
            await loadReferralStats(referralCode);
            await loadICMarketsSection(userData);
            loadReferredMembers(referralCode);
        });

        document.getElementById('copyArcaneBtn').addEventListener('click', () => {
            const input = document.getElementById('arcaneRefLink');
            input.select();
            navigator.clipboard.writeText(input.value);
            
            const btn = document.getElementById('copyArcaneBtn');
            btn.textContent = '‚úÖ Copied!';
            setTimeout(() => {
                btn.textContent = 'üìã Copy';
            }, 2000);
        });

        async function loadReferralStats(referralCode) {
            try {
                // Query Users collection directly for accurate counts
                const usersRef = collection(db, 'Users');
                const q = query(usersRef, where('referredBy', '==', referralCode));
                const querySnapshot = await getDocs(q);

                let total = querySnapshot.size;
                let active = 0;

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.isPaid === true || userData.subscriptionStatus === 'active') {
                        active++;
                    }
                });

                const pending = total - active;
                const monthlyEarnings = active * 25;

                document.getElementById('totalReferrals').textContent = total;
                document.getElementById('activeMembers').textContent = active;
                document.getElementById('pendingReferrals').textContent = pending;
                document.getElementById('monthlyEarnings').textContent = `¬£${monthlyEarnings}`;

            } catch (error) {
                console.error('Error loading referral stats:', error);
                // Show zeros on error
                document.getElementById('totalReferrals').textContent = '0';
                document.getElementById('activeMembers').textContent = '0';
                document.getElementById('pendingReferrals').textContent = '0';
                document.getElementById('monthlyEarnings').textContent = '¬£0';
            }
        }

        async function loadReferredMembers(referralCode) {
            console.log('Loading referrals for code:', referralCode);
            
            try {
                const tbody = document.getElementById('referralsTableBody');

                // Query Users collection for anyone who used this referral code
                const usersRef = collection(db, 'Users');
                const q = query(usersRef, where('referredBy', '==', referralCode));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align:center;color:var(--text-dim);">
                                No referrals yet. Share your link to get started!
                            </td>
                        </tr>
                    `;
                    return;
                }

                console.log('Found', querySnapshot.size, 'referrals');

                // Convert to array and sort by joinedAt (newest first)
                const referrals = [];
                querySnapshot.forEach((doc) => {
                    referrals.push({ id: doc.id, ...doc.data() });
                });

                referrals.sort((a, b) => {
                    const aTime = a.joinedAt?.toMillis ? a.joinedAt.toMillis() : 0;
                    const bTime = b.joinedAt?.toMillis ? b.joinedAt.toMillis() : 0;
                    return bTime - aTime;
                });

                tbody.innerHTML = '';

                referrals.forEach((userData) => {
                    const isActive = userData.isPaid === true || userData.subscriptionStatus === 'active';
                    const status = isActive ? 'active' : 'pending';
                    const monthlyValue = isActive ? '¬£25' : '¬£0';
                    const username = userData.Username || userData.Email?.split('@')[0] || 'New Member';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(userData.joinedAt)}</td>
                        <td>${username}</td>
                        <td><span class="status-badge ${status}">${isActive ? 'Active' : 'Pending'}</span></td>
                        <td>${monthlyValue}/mo</td>
                    `;

                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading referrals:', error);
                document.getElementById('referralsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:center;color:var(--red);">
                            Error loading referrals. Please refresh the page.
                        </td>
                    </tr>
                `;
            }
        }

        async function loadICMarketsSection(userData) {
            const vantageContent = document.getElementById('vantageContent');
            
            if (userData.vantageIBLink) {
                vantageContent.innerHTML = `
                    <div class="link-box">
                        <label>Your Sub-IB Link</label>
                        <div class="link-display">
                            <input 
                                type="text" 
                                id="vantageLinkDisplay" 
                                readonly 
                                value="${userData.vantageIBLink}"
                                class="link-input"
                            />
                            <button class="copy-btn" id="copyVantageBtn">üìã Copy</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="number" style="color: var(--purple-light);">Rebates</div>
                            <div class="label">Your Commission</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" style="color: var(--gold);">Override</div>
                            <div class="label">Sub-IB Commission</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" style="color: var(--green);">Direct</div>
                            <div class="label">Payment Method</div>
                        </div>
                    </div>

                    <div class="info-box">
                        <h3>üí° How Vantage Markets Works</h3>
                        <ul>
                            <li><strong>Your Commission:</strong> Earn rebates on trades from your direct referrals</li>
                            <li><strong>Override:</strong> Earn additional rebates from your Sub-IBs</li>
                            <li><strong>Payment:</strong> Vantage Markets pays you DIRECTLY monthly</li>
                            <li><strong>Separate:</strong> Vantage rebates NOT withdrawn through this platform</li>
                        </ul>
                    </div>
                `;

                document.getElementById('copyVantageBtn').addEventListener('click', () => {
                    const input = document.getElementById('vantageLinkDisplay');
                    input.select();
                    navigator.clipboard.writeText(input.value);
                    
                    const btn = document.getElementById('copyVantageBtn');
                    btn.textContent = '‚úÖ Copied!';
                    setTimeout(() => {
                        btn.textContent = 'üìã Copy';
                    }, 2000);
                });

            } else {
                vantageContent.innerHTML = `
                    <div class="info-box" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üè¶</div>
                        <h3 style="margin-bottom: 1rem;">Vantage Markets Not Connected</h3>
                        <p style="margin-bottom: 2rem;">Unlock unlimited earning potential</p>
                        
                        <button onclick="window.location.href='settings.html'" class="btn-submit" style="width: auto; padding: 0.75rem 2rem; display: inline-block;">
                            ‚öôÔ∏è Connect in Settings
                        </button>
                    </div>
                `;
            }
        }

        async function loadAffiliateEarnings() {
            const affiliateDoc = await getDoc(doc(db, 'Affiliates', currentUser.uid));
            
            if (affiliateDoc.exists()) {
                const data = affiliateDoc.data();
                document.getElementById('availableBalance').textContent = `¬£${(data.availableBalance || 0).toFixed(2)}`;
                document.getElementById('pendingBalance').textContent = `¬£${(data.pendingBalance || 0).toFixed(2)}`;
                document.getElementById('totalEarned').textContent = `¬£${(data.totalEarnings || 0).toFixed(2)}`;
                document.getElementById('totalWithdrawn').textContent = `¬£${(data.totalWithdrawn || 0).toFixed(2)}`;
            }
        }

        async function loadWithdrawalHistory() {
            try {
                const q = query(
                    collection(db, 'WithdrawalRequests'),
                    where('userId', '==', currentUser.uid),
                    limit(10)
                );

                const snapshot = await getDocs(q);
                const tbody = document.getElementById('withdrawalHistoryBody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align:center;color:var(--text-dim);">
                                No withdrawals yet
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';

                // Sort manually
                const withdrawals = [];
                snapshot.forEach((docSnap) => {
                    withdrawals.push(docSnap.data());
                });

                withdrawals.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis() || 0;
                    const bTime = b.createdAt?.toMillis() || 0;
                    return bTime - aTime;
                });

                withdrawals.forEach((data) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(data.createdAt)}</td>
                        <td>¬£${data.amount.toFixed(2)}</td>
                        <td>${data.method.toUpperCase()}</td>
                        <td><span class="status-badge ${data.status}">${capitalizeFirst(data.status)}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading withdrawal history:', error);
            }
        }

        document.getElementById('bankForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('bankAmount').value);

            if (amount < 50) {
                alert('Minimum withdrawal is ¬£50');
                return;
            }

            const withdrawalData = {
                userId: currentUser.uid,
                amount: amount,
                method: 'bank',
                accountName: document.getElementById('accountName').value,
                bankName: document.getElementById('bankName').value,
                accountNumber: document.getElementById('accountNumber').value,
                sortCode: document.getElementById('sortCode').value,
                status: 'pending',
                createdAt: serverTimestamp()
            };

            try {
                const withdrawalRef = doc(collection(db, 'WithdrawalRequests'));
                await setDoc(withdrawalRef, withdrawalData);
                
                alert('‚úÖ Withdrawal request submitted!');
                document.getElementById('bankForm').reset();
                loadWithdrawalHistory();
            } catch (error) {
                alert('‚ùå Failed. Please try again.');
            }
        });

        document.getElementById('cryptoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('cryptoAmount').value);

            if (amount < 50) {
                alert('Minimum withdrawal is ¬£50');
                return;
            }

            const withdrawalData = {
                userId: currentUser.uid,
                amount: amount,
                method: 'crypto',
                cryptoType: document.getElementById('cryptoType').value,
                walletAddress: document.getElementById('walletAddress').value,
                network: document.getElementById('cryptoNetwork').value,
                status: 'pending',
                createdAt: serverTimestamp()
            };

            try {
                const withdrawalRef = doc(collection(db, 'WithdrawalRequests'));
                await setDoc(withdrawalRef, withdrawalData);
                
                alert('‚úÖ Withdrawal request submitted!');
                document.getElementById('cryptoForm').reset();
                loadWithdrawalHistory();
            } catch (error) {
                alert('‚ùå Failed. Please try again.');
            }
        });

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>