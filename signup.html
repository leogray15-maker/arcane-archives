<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Sign Up | The Arcane Archives</title>
<link rel="icon" href="ArcaneA.png">
<link rel="apple-touch-icon" href="ArcaneA.png">
<link rel="apple-touch-icon" sizes="180x180" href="ArcaneA.png">
<link rel="apple-touch-icon" sizes="152x152" href="ArcaneA.png">
<link rel="apple-touch-icon" sizes="120x120" href="ArcaneA.png">
<meta name="apple-mobile-web-app-title" content="Arcane Archives">

<style>
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html {
  height: 100%;
  overflow-x: hidden;
}

body {
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top, #111827, #02010a 60%, #000);
  color: #e5e5e5;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: env(safe-area-inset-top, 1rem) env(safe-area-inset-right, 1rem) env(safe-area-inset-bottom, 1rem) env(safe-area-inset-left, 1rem);
}

.container {
  width: 100%;
  max-width: 520px;
  padding: 1rem;
}

.referral-banner {
  background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(76, 29, 149, 0.2));
  border: 1px solid rgba(147, 51, 234, 0.4);
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.referral-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.referral-content {
  flex: 1;
}

.referral-content strong {
  display: block;
  color: #a78bfa;
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.referral-content p {
  color: #a3a3a3;
  font-size: 0.85rem;
  margin: 0;
  text-align: left;
}

.box {
  width: 100%;
  background: rgba(15,23,42,.96);
  border-radius: 20px;
  border: 1px solid rgba(148,163,184,.4);
  padding: 1.5rem;
  box-shadow: 0 30px 120px rgba(15, 23, 42, 0.85);
}

h1 {
  margin: 0 0 0.5rem 0;
  text-align: center;
  font-size: 1.6rem;
  background: linear-gradient(135deg, #a78bfa, #fbbf24);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.subtitle {
  text-align: center;
  color: #a3a3a3;
  margin-bottom: 1.5rem;
  font-size: 0.95rem;
}

label {
  display: block;
  font-size: 0.85rem;
  color: #a3a3a3;
  margin-top: 0.8rem;
  margin-bottom: 0.3rem;
  font-weight: 500;
}

input, select, button {
  width: 100%;
  padding: 0.9rem;
  border-radius: 10px;
  border: 1px solid rgba(148,163,184,.4);
  background: rgba(15,23,42,.95);
  color: #e5e5e5;
  font-family: inherit;
  font-size: 16px; /* Prevents iOS zoom */
  transition: all 0.2s;
  -webkit-appearance: none;
  appearance: none;
}

select {
  background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23a3a3a3' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.9rem center;
  padding-right: 2.5rem;
}

input[type="date"] {
  color: #a3a3a3;
}

input[type="date"]:focus,
input[type="date"]:valid {
  color: #e5e5e5;
}

input:focus, select:focus {
  outline: none;
  border-color: #9333ea;
  box-shadow: 0 0 0 3px rgba(147,51,234,0.2);
}

button {
  margin-top: 1rem;
  background: linear-gradient(135deg,#9333ea,#7e22ce);
  border: none;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 1rem;
}

button:active {
  transform: scale(0.98);
}

button:disabled {
  opacity: .5;
  cursor: not-allowed;
}

.progress {
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(10,10,10,.8);
  border-radius: 12px;
  display: none;
}

.step {
  display: flex;
  align-items: center;
  gap: .6rem;
  padding: .4rem 0;
  color: #a3a3a3;
  font-size: 0.9rem;
}

.step.active {
  color: #a78bfa;
}

.step.done {
  color: #22c55e;
}

.success {
  background: rgba(34,197,94,.1);
  border: 1px solid rgba(34,197,94,.3);
  color: #22c55e;
  padding: 1rem;
  border-radius: 12px;
  text-align: center;
  display: none;
  margin-top: 1rem;
  font-size: 0.9rem;
  line-height: 1.6;
}

.error {
  background: rgba(239,68,68,.1);
  border: 1px solid rgba(239,68,68,.3);
  color: #ef4444;
  padding: 1rem;
  border-radius: 12px;
  text-align: center;
  display: none;
  margin-top: 1rem;
  font-size: 0.9rem;
}

.checkbox-group {
  display: flex;
  align-items: flex-start;
  gap: 0.6rem;
  margin-top: 0.8rem;
}

.checkbox-group input[type="checkbox"] {
  width: 20px;
  height: 20px;
  min-width: 20px;
  margin-top: 0.1rem;
  cursor: pointer;
}

.checkbox-group label {
  margin: 0;
  font-size: 0.85rem;
  cursor: pointer;
  line-height: 1.4;
}

.checkbox-group a {
  color: #a78bfa;
  text-decoration: none;
}

.checkbox-group a:active {
  opacity: 0.7;
}

.login-link {
  text-align: center;
  margin-top: 1.5rem;
  color: #a3a3a3;
  font-size: 0.9rem;
}

.login-link a {
  color: #a78bfa;
  text-decoration: none;
  font-weight: 600;
}

.login-link a:active {
  opacity: 0.7;
}

/* Mobile specific */
@media (max-width: 640px) {
  .box {
    padding: 1.2rem;
    border-radius: 16px;
  }

  h1 {
    font-size: 1.5rem;
  }

  .subtitle {
    font-size: 0.9rem;
  }

  label {
    font-size: 0.8rem;
    margin-top: 0.7rem;
  }

  input, select, button {
    padding: 0.85rem;
  }

  .referral-banner {
    padding: 0.9rem;
  }

  .referral-icon {
    font-size: 1.8rem;
  }
}

/* Very small screens */
@media (max-width: 380px) {
  .container {
    padding: 0.5rem;
  }

  .box {
    padding: 1rem;
  }

  h1 {
    font-size: 1.3rem;
  }

  input, select, button {
    padding: 0.8rem;
    font-size: 15px;
  }
}
</style>
</head>
<body>

<div class="container">
  <div id="referralBanner"></div>

  <div class="box">
    <h1>Create Your Account</h1>
    <p class="subtitle">Join The Arcane Archives</p>

    <form id="signupForm">
      <label>Username *</label>
      <input type="text" id="username" required placeholder="Choose a username" autocomplete="username">

      <label>First Name *</label>
      <input type="text" id="firstName" required placeholder="Your first name" autocomplete="given-name">

      <label>Last Name *</label>
      <input type="text" id="lastName" required placeholder="Your last name" autocomplete="family-name">

      <label>Email *</label>
      <input type="email" id="email" required placeholder="your@email.com" autocomplete="email">

      <label>Phone Number</label>
      <input type="tel" id="phone" placeholder="+44 7700 900000" autocomplete="tel">

      <label>Date of Birth *</label>
      <input type="date" id="dob" required autocomplete="bday">

      <label>Address Line 1 *</label>
      <input type="text" id="address1" required placeholder="Street address" autocomplete="address-line1">

      <label>Address Line 2</label>
      <input type="text" id="address2" placeholder="Apartment, suite (optional)" autocomplete="address-line2">

      <label>City *</label>
      <input type="text" id="city" required placeholder="City" autocomplete="address-level2">

      <label>State/County *</label>
      <input type="text" id="state" required placeholder="State or County" autocomplete="address-level1">

      <label>Postal Code *</label>
      <input type="text" id="postal" required placeholder="Postcode" autocomplete="postal-code">

      <label>Country *</label>
      <select id="country" required autocomplete="country">
        <option value="">Select your country</option>
        <option value="GB">United Kingdom</option>
        <option value="US">United States</option>
        <option value="CA">Canada</option>
        <option value="AU">Australia</option>
        <option value="DE">Germany</option>
        <option value="FR">France</option>
        <option value="ES">Spain</option>
        <option value="IT">Italy</option>
        <option value="NL">Netherlands</option>
        <option value="IE">Ireland</option>
        <option value="OTHER">Other</option>
      </select>

      <label>Password *</label>
      <input type="password" id="password" required placeholder="Create a strong password" autocomplete="new-password">

      <label>Confirm Password *</label>
      <input type="password" id="confirmPassword" required placeholder="Confirm your password" autocomplete="new-password">

      <label>Referral Code (Optional)</label>
      <input type="text" id="referralCode" placeholder="Enter referral code (e.g., ARCANE)" autocomplete="off" style="text-transform: uppercase;">

      <div class="checkbox-group">
        <input type="checkbox" id="newsletter">
        <label for="newsletter">I want to receive updates and newsletters</label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="terms" required>
        <label for="terms">I agree to the <a href="terms-of-service.html" target="_blank">Terms of Service</a> *</label>
      </div>

      <button type="submit" id="submitBtn">Create Account</button>
    </form>

    <div class="progress" id="progressBox">
      <div class="step" id="step1">‚è≥ Creating account...</div>
      <div class="step" id="step2">‚è≥ Setting up profile...</div>
      <div class="step" id="step3">‚è≥ Saving your data...</div>
      <div class="step" id="step4">‚è≥ Sending verification email...</div>
      <div class="step" id="step5">‚è≥ Finishing up...</div>
    </div>

    <div class="success" id="successBox"></div>
    <div class="error" id="errorBox"></div>

    <div class="login-link">
      Already have an account? <a href="login.html">Log in</a>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
import { 
  getAuth, 
  createUserWithEmailAndPassword,
  updateProfile,
  sendEmailVerification
} from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
import { 
  getFirestore, 
  doc, 
  setDoc,
  serverTimestamp,
  query,
  collection,
  where,
  getDocs,
  updateDoc,
  increment,
  getDoc
} from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
  authDomain: "arcane-archives-3b0f5.firebaseapp.com",
  projectId: "arcane-archives-3b0f5",
  storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
  messagingSenderId: "264237235055",
  appId: "1:264237235055:web:4a2e5605b0ffb5307f069a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Check for referral code in URL
const urlParams = new URLSearchParams(window.location.search);
const referralCode = urlParams.get('ref');

if (referralCode) {
  sessionStorage.setItem('referralCode', referralCode);
  
  const banner = document.getElementById('referralBanner');
  banner.innerHTML = `
    <div class="referral-banner">
      <span class="referral-icon">üéØ</span>
      <div class="referral-content">
        <strong>Referred by: ${referralCode}</strong>
        <p>Sign up now to join their community</p>
      </div>
    </div>
  `;
}

function showProgress(stepNum) {
  document.getElementById('progressBox').style.display = 'block';
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById(`step${i}`);
    if (i < stepNum) {
      el.classList.add('done');
      el.classList.remove('active');
      el.innerHTML = el.innerHTML.replace('‚è≥', '‚úÖ');
    } else if (i === stepNum) {
      el.classList.add('active');
      el.classList.remove('done');
    } else {
      el.classList.remove('active', 'done');
    }
  }
}

function showSuccess(msg) {
  const box = document.getElementById('successBox');
  box.innerHTML = msg;
  box.style.display = 'block';
  document.getElementById('errorBox').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showError(msg) {
  const box = document.getElementById('errorBox');
  box.innerHTML = msg;
  box.style.display = 'block';
  document.getElementById('successBox').style.display = 'none';
  document.getElementById('progressBox').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.getElementById('signupForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = document.getElementById('username').value.trim();
  const first = document.getElementById('firstName').value.trim();
  const last = document.getElementById('lastName').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const dob = document.getElementById('dob').value;
  const address1 = document.getElementById('address1').value.trim();
  const address2 = document.getElementById('address2').value.trim();
  const city = document.getElementById('city').value.trim();
  const state = document.getElementById('state').value.trim();
  const postal = document.getElementById('postal').value.trim();
  const country = document.getElementById('country').value;
  const pass = document.getElementById('password').value;
  const confirmPass = document.getElementById('confirmPassword').value;
  const referralCodeInput = document.getElementById('referralCode').value.trim().toUpperCase();
  const newsletter = document.getElementById('newsletter').checked;
  const terms = document.getElementById('terms').checked;

  const btn = document.getElementById('submitBtn');

  // Validation
  if (!username || !first || !last || !email || !dob || !address1 || !city || !state || !postal || !country || !pass || !confirmPass) {
    showError('‚ùå Please fill in all required fields');
    return;
  }

  if (pass !== confirmPass) {
    showError('‚ùå Passwords do not match');
    return;
  }

  if (pass.length < 8) {
    showError('‚ùå Password must be at least 8 characters');
    return;
  }

  if (!terms) {
    showError('‚ùå You must agree to the Terms of Service');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Creating account...';

  try {
    // Step 1: Create auth account
    showProgress(1);
    
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const user = cred.user;
    
    // Step 2: Update profile
    showProgress(2);
    
    await updateProfile(user, { 
      displayName: username 
    });

    // Step 3: Create Firestore document
    showProgress(3);
    
    const defaultReferralCode = user.uid.slice(0, 8).toUpperCase();
    
    // Get referral code from input field OR sessionStorage (URL param takes priority)
    const urlReferralCode = sessionStorage.getItem('referralCode');
    const referralCodeToUse = urlReferralCode || referralCodeInput;
    
    let referredBy = null;

    // Validate referral code if provided
    if (referralCodeToUse) {
      const referrerQuery = query(
        collection(db, 'Users'),
        where('referralCode', '==', referralCodeToUse.toUpperCase())
      );
      const referrerSnapshot = await getDocs(referrerQuery);
      
      if (!referrerSnapshot.empty) {
        referredBy = referralCodeToUse.toUpperCase();
        console.log('‚úÖ Valid referral code:', referredBy);
      } else {
        console.warn('‚ö†Ô∏è Invalid referral code:', referralCodeToUse);
      }
    }
    
    const userData = {
      Username: username,
      FirstName: first,
      LastName: last,
      Email: email,
      Phone: phone,
      DateOfBirth: dob,
      Address: {
        line1: address1,
        line2: address2 || "",
        city: city,
        state: state,
        postal: postal,
        country: country
      },
      Country: country,
      NewsletterOptIn: newsletter,
      referralCode: defaultReferralCode,
      isPaid: false,
      subscriptionStatus: "none",
      emailVerified: false,
      joinedAt: serverTimestamp(),
      lastLoginDate: serverTimestamp()
    };

    if (referredBy) {
      userData.referredBy = referredBy;
      userData.referredAt = serverTimestamp();
    }
    
    await setDoc(doc(db, "Users", user.uid), userData);

    // Update referrer stats
    if (referredBy) {
      try {
        const referrerQuery = query(
          collection(db, 'Users'),
          where('referralCode', '==', referredBy)
        );
        const referrerSnapshot = await getDocs(referrerQuery);
        
        if (!referrerSnapshot.empty) {
          const referrerId = referrerSnapshot.docs[0].id;
          const affiliateRef = doc(db, 'Affiliates', referrerId);
          const affiliateDoc = await getDoc(affiliateRef);
          
          if (affiliateDoc.exists()) {
            await updateDoc(affiliateRef, {
              totalReferrals: increment(1),
              lastUpdated: serverTimestamp()
            });
          } else {
            await setDoc(affiliateRef, {
              userId: referrerId,
              referralCode: referredBy,
              availableBalance: 0,
              pendingBalance: 0,
              totalEarnings: 0,
              totalWithdrawn: 0,
              activeReferrals: 0,
              totalReferrals: 1,
              createdAt: serverTimestamp(),
              lastUpdated: serverTimestamp()
            });
          }
        }
      } catch (error) {
        console.error("Error updating referrer:", error);
      }
    }

    sessionStorage.removeItem('referralCode');

    // Step 4: Send verification email
    showProgress(4);
    
    await sendEmailVerification(user);

    // Step 5: Sign out user
    await auth.signOut();

    showProgress(5);
    
    showSuccess(`
      <strong>üéâ Account created!</strong><br><br>
      <strong>üìß Verify your email to login</strong><br>
      Check <strong>${email}</strong><br><br>
      ‚ö†Ô∏è <strong style="color: #fbbf24;">Check SPAM folder!</strong><br><br>
      <small style="color: #a3a3a3;">Redirecting in 5 seconds...</small>
    `);

    setTimeout(() => {
      window.location.href = "login.html";
    }, 5000);

  } catch (err) {
    console.error("Signup error:", err);
    
    let errorMsg = "‚ùå Failed to create account. Please try again.";
    
    if (err.code === 'auth/email-already-in-use') {
      errorMsg = "‚ùå Email already registered. <a href='login.html' style='color: #a78bfa; text-decoration: underline;'>Log in</a>";
    } else if (err.code === 'auth/invalid-email') {
      errorMsg = "‚ùå Invalid email address";
    } else if (err.code === 'auth/weak-password') {
      errorMsg = "‚ùå Password too weak. Use 8+ characters.";
    } else if (err.code === 'auth/network-request-failed') {
      errorMsg = "‚ùå Network error. Check connection.";
    }
    
    showError(errorMsg);
    btn.disabled = false;
    btn.textContent = "Create Account";
  }
});
</script>

</body>
</html>