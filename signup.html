<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Sign Up | The Arcane Archives</title>
<link rel="icon" href="ArcaneA.png">
<link rel="apple-touch-icon" href="ArcaneA.png">
<meta name="apple-mobile-web-app-title" content="Arcane Archives">

<style>
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html {
  height: 100%;
  overflow-x: hidden;
}

body {
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top, #111827, #02010a 60%, #000);
  color: #e5e5e5;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: env(safe-area-inset-top, 1rem) env(safe-area-inset-right, 1rem) env(safe-area-inset-bottom, 1rem) env(safe-area-inset-left, 1rem);
}

.container {
  width: 100%;
  max-width: 520px;
  padding: 1rem;
}

.referral-banner {
  background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(76, 29, 149, 0.2));
  border: 1px solid rgba(147, 51, 234, 0.4);
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.referral-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.referral-content {
  flex: 1;
}

.referral-content strong {
  display: block;
  color: #a78bfa;
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.referral-content p {
  color: #a3a3a3;
  font-size: 0.85rem;
  margin: 0;
  text-align: left;
}

.box {
  width: 100%;
  background: rgba(15,23,42,.96);
  border-radius: 20px;
  border: 1px solid rgba(148,163,184,.4);
  padding: 1.5rem;
  box-shadow: 0 30px 120px rgba(15, 23, 42, 0.85);
}

h1 {
  margin: 0 0 0.5rem 0;
  text-align: center;
  font-size: 1.6rem;
  background: linear-gradient(135deg, #a78bfa, #fbbf24);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.subtitle {
  text-align: center;
  color: #a3a3a3;
  font-size: 0.95rem;
  margin-bottom: 1.2rem;
}

label {
  display: block;
  margin-top: 0.9rem;
  font-size: 0.85rem;
  color: #a3a3a3;
  font-weight: 500;
}

input, select {
  width: 100%;
  background: rgba(15,23,42,.85);
  border: 1px solid rgba(148,163,184,.3);
  border-radius: 10px;
  padding: 0.9rem;
  color: #e5e5e5;
  font-size: 16px;
  outline: none;
  margin-top: 0.3rem;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

input:focus, select:focus {
  border-color: #a78bfa;
}

button {
  width: 100%;
  background: linear-gradient(135deg, #9333ea, #7e22ce);
  color: white;
  border: none;
  border-radius: 999px;
  padding: 1rem;
  font-weight: 700;
  font-size: 1.05rem;
  margin-top: 1.2rem;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-appearance: none;
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

button:active {
  transform: scale(0.98);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.success {
  background: rgba(16,185,129,.1);
  border: 1px solid rgba(16,185,129,.3);
  color: #10b981;
  padding: 1rem;
  border-radius: 12px;
  text-align: center;
  display: none;
  margin-top: 1rem;
  font-size: 0.9rem;
  line-height: 1.6;
}

.error {
  background: rgba(239,68,68,.1);
  border: 1px solid rgba(239,68,68,.3);
  color: #ef4444;
  padding: 1rem;
  border-radius: 12px;
  text-align: center;
  display: none;
  margin-top: 1rem;
  font-size: 0.9rem;
}

/* CUSTOM CHECKBOX STYLING */
.checkbox-group {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  margin-top: 1rem;
  cursor: pointer;
  user-select: none;
}

.checkbox-group input[type="checkbox"] {
  /* Hide default checkbox but keep it functional */
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.checkbox-group .custom-checkbox {
  width: 24px;
  height: 24px;
  min-width: 24px;
  border: 2px solid rgba(148, 163, 184, 0.4);
  border-radius: 6px;
  background: rgba(15, 23, 42, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  margin-top: 0.1rem;
}

.checkbox-group input[type="checkbox"]:checked ~ .custom-checkbox {
  background: linear-gradient(135deg, #9333ea, #7e22ce);
  border-color: #9333ea;
}

.checkbox-group .custom-checkbox::after {
  content: "‚úì";
  color: white;
  font-size: 16px;
  font-weight: bold;
  opacity: 0;
  transform: scale(0);
  transition: all 0.2s;
}

.checkbox-group input[type="checkbox"]:checked ~ .custom-checkbox::after {
  opacity: 1;
  transform: scale(1);
}

.checkbox-group .checkbox-label {
  margin: 0;
  font-size: 0.85rem;
  line-height: 1.4;
  flex: 1;
  cursor: pointer;
}

.checkbox-group a {
  color: #a78bfa;
  text-decoration: none;
}

.checkbox-group a:active {
  opacity: 0.7;
}

.login-link {
  text-align: center;
  margin-top: 1.5rem;
  color: #a3a3a3;
  font-size: 0.9rem;
}

.login-link a {
  color: #a78bfa;
  text-decoration: none;
  font-weight: 600;
}

.login-link a:active {
  opacity: 0.7;
}

/* Mobile specific */
@media (max-width: 640px) {
  .box {
    padding: 1.2rem;
    border-radius: 16px;
  }

  h1 {
    font-size: 1.5rem;
  }

  .subtitle {
    font-size: 0.9rem;
  }

  label {
    font-size: 0.8rem;
    margin-top: 0.7rem;
  }

  input, select, button {
    padding: 0.85rem;
  }

  .referral-banner {
    padding: 0.9rem;
  }

  .referral-icon {
    font-size: 1.8rem;
  }
}

/* Very small screens */
@media (max-width: 380px) {
  .container {
    padding: 0.5rem;
  }

  .box {
    padding: 1rem;
  }

  h1 {
    font-size: 1.3rem;
  }

  input, select, button {
    padding: 0.8rem;
    font-size: 15px;
  }
}
</style>
</head>
<body>

<div class="container">
  <div id="referralBanner"></div>

  <div class="box">
    <h1>Create Your Account</h1>
    <p class="subtitle">Join The Arcane Archives</p>

    <form id="signupForm">
      <label>Username *</label>
      <input type="text" id="username" required placeholder="Choose a username" autocomplete="username">

      <label>First Name *</label>
      <input type="text" id="firstName" required placeholder="Your first name" autocomplete="given-name">

      <label>Last Name *</label>
      <input type="text" id="lastName" required placeholder="Your last name" autocomplete="family-name">

      <label>Email *</label>
      <input type="email" id="email" required placeholder="your@email.com" autocomplete="email">

      <label>Phone Number</label>
      <input type="tel" id="phone" placeholder="+44 7700 900000" autocomplete="tel">

      <label>Date of Birth *</label>
      <input type="date" id="dob" required autocomplete="bday">

      <label>Address Line 1 *</label>
      <input type="text" id="address1" required placeholder="Street address" autocomplete="address-line1">

      <label>Address Line 2</label>
      <input type="text" id="address2" placeholder="Apartment, suite, etc. (optional)" autocomplete="address-line2">

      <label>City *</label>
      <input type="text" id="city" required placeholder="City" autocomplete="address-level2">

      <label>County / State *</label>
      <input type="text" id="county" required placeholder="County or State" autocomplete="address-level1">

      <label>Postcode / ZIP *</label>
      <input type="text" id="postcode" required placeholder="Postcode or ZIP" autocomplete="postal-code">

      <label>Country *</label>
      <select id="country" required autocomplete="country">
        <option value="">Select your country</option>
        <option value="GB">United Kingdom</option>
        <option value="US">United States</option>
        <option value="CA">Canada</option>
        <option value="AU">Australia</option>
        <option value="IE">Ireland</option>
        <option value="NZ">New Zealand</option>
        <option value="DE">Germany</option>
        <option value="FR">France</option>
        <option value="ES">Spain</option>
        <option value="IT">Italy</option>
        <option value="NL">Netherlands</option>
        <option value="BE">Belgium</option>
        <option value="SE">Sweden</option>
        <option value="NO">Norway</option>
        <option value="DK">Denmark</option>
        <option value="FI">Finland</option>
        <option value="PL">Poland</option>
        <option value="CH">Switzerland</option>
        <option value="AT">Austria</option>
        <option value="PT">Portugal</option>
      </select>

      <label>Password *</label>
      <input type="password" id="password" required placeholder="Create a strong password" autocomplete="new-password">

      <label>Confirm Password *</label>
      <input type="password" id="confirmPassword" required placeholder="Confirm your password" autocomplete="new-password">

      <label>Referral Code (Optional)</label>
      <input type="text" id="referralCode" placeholder="Enter referral code (e.g., ARCANE)" style="text-transform: uppercase;">

      <!-- NEWSLETTER CHECKBOX (Optional) -->
      <label class="checkbox-group">
        <input type="checkbox" id="newsletter" checked>
        <div class="custom-checkbox"></div>
        <span class="checkbox-label">I want to receive updates and newsletters</span>
      </label>

      <!-- TERMS CHECKBOX (Required) -->
      <label class="checkbox-group">
        <input type="checkbox" id="terms" required>
        <div class="custom-checkbox"></div>
        <span class="checkbox-label">I agree to the <a href="terms.html" target="_blank" onclick="event.stopPropagation()">Terms of Service</a> *</span>
      </label>

      <button type="submit">Create Account</button>
    </form>

    <div class="success" id="successMsg">
      <strong>‚úÖ Account created successfully!</strong><br>
      <strong>üìß Verification email sent!</strong><br><br>
      Please check your email inbox (and spam folder) to verify your account.<br>
      <small style="margin-top: 0.5rem; display: block;">Redirecting to login in <span id="countdown">8</span> seconds...</small>
    </div>

    <div class="error" id="errorMsg"></div>

    <div class="login-link">
      Already have an account? <a href="login.html">Log in</a>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
  authDomain: "arcane-archives-3b0f5.firebaseapp.com",
  projectId: "arcane-archives-3b0f5",
  storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
  messagingSenderId: "264237235055",
  appId: "1:264237235055:web:4a2e5605b0ffb5307f069a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Check for referral code in URL
const urlParams = new URLSearchParams(window.location.search);
const refCode = urlParams.get('ref');
if (refCode) {
  document.getElementById('referralCode').value = refCode.toUpperCase();
  
  const banner = document.getElementById('referralBanner');
  banner.innerHTML = `
    <div class="referral-banner">
      <div class="referral-icon">üéÅ</div>
      <div class="referral-content">
        <strong>You've been referred!</strong>
        <p>Referral code <strong>${refCode.toUpperCase()}</strong> has been applied</p>
      </div>
    </div>
  `;
}

document.getElementById('signupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const errorMsg = document.getElementById('errorMsg');
  const successMsg = document.getElementById('successMsg');
  
  errorMsg.style.display = 'none';
  successMsg.style.display = 'none';
  
  // Check if terms are accepted
  if (!document.getElementById('terms').checked) {
    errorMsg.textContent = 'You must accept the Terms of Service to continue';
    errorMsg.style.display = 'block';
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Creating Account...';
  
  try {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (password !== confirmPassword) {
      throw new Error('Passwords do not match');
    }
    
    if (password.length < 6) {
      throw new Error('Password must be at least 6 characters');
    }
    
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    const referralCode = document.getElementById('referralCode').value.trim().toUpperCase();
    const newsletter = document.getElementById('newsletter').checked;
    
    const userData = {
      Username: document.getElementById('username').value.trim(),
      FirstName: document.getElementById('firstName').value.trim(),
      LastName: document.getElementById('lastName').value.trim(),
      Email: email,
      Phone: document.getElementById('phone').value.trim() || null,
      DateOfBirth: document.getElementById('dob').value,
      Address: {
        line1: document.getElementById('address1').value.trim(),
        line2: document.getElementById('address2').value.trim() || null,
        city: document.getElementById('city').value.trim(),
        county: document.getElementById('county').value.trim(),
        postcode: document.getElementById('postcode').value.trim(),
        country: document.getElementById('country').value
      },
      referralCode: user.uid.slice(0, 8).toUpperCase(),
      referredBy: referralCode || null,
      subscribeToNewsletter: newsletter,
      subscriptionStatus: "none",
      isPaid: false,
      Xp: 0,
      Level: "Seeker",
      WinsPosted: 0,
      CallAttended: 0,
      ModulesCompleted: 0,
      completedModuleIds: [],
      joinedAt: serverTimestamp(),
      lastLoginDate: serverTimestamp(),
      loginStreak: 1
    };
    
    await setDoc(doc(db, "Users", user.uid), userData);
    
    // Send verification email
    try {
      await sendEmailVerification(user);
      console.log('Verification email sent');
    } catch (emailError) {
      console.error('Error sending verification email:', emailError);
      // Continue anyway - user can request verification later
    }
    
    successMsg.style.display = 'block';
    
    // Countdown timer
    let seconds = 8;
    const countdownEl = document.getElementById('countdown');
    
    const countdownInterval = setInterval(() => {
      seconds--;
      if (countdownEl) countdownEl.textContent = seconds;
      
      if (seconds <= 0) {
        clearInterval(countdownInterval);
        window.location.href = 'login.html';
      }
    }, 1000);
    
  } catch (error) {
    console.error('Signup error:', error);
    errorMsg.textContent = error.message;
    errorMsg.style.display = 'block';
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Account';
  }
});
</script>

</body>
</html>