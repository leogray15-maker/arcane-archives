<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        updateProfile 
    } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        serverTimestamp,
        query,
        collection,
        where,
        getDocs
    } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
        authDomain: "arcane-archives-3b0f5.firebaseapp.com",
        projectId: "arcane-archives-3b0f5",
        storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
        messagingSenderId: "264237235055",
        appId: "1:264237235055:web:4a2e5605b0ffb5307f069a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Check for referral code in URL
    const urlParams = new URLSearchParams(window.location.search);
    const referralCode = urlParams.get('ref');

    if (referralCode) {
        // Store in sessionStorage
        sessionStorage.setItem('referralCode', referralCode);
        
        // Display referral info
        const referralInfo = document.createElement('div');
        referralInfo.className = 'referral-banner';
        referralInfo.innerHTML = `
            <div class="referral-content">
                <span class="referral-icon">üéØ</span>
                <div>
                    <strong>Referred by: ${referralCode}</strong>
                    <p>Sign up now to join their community</p>
                </div>
            </div>
        `;
        document.querySelector('.signup-container').prepend(referralInfo);
    }

    const form = document.getElementById('signupForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusMsg = document.getElementById('statusMsg');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const termsAccepted = document.getElementById('terms').checked;

        // Validation
        if (!username || !email || !password || !confirmPassword) {
            statusMsg.textContent = '‚ùå Please fill in all fields';
            statusMsg.style.color = '#ef4444';
            return;
        }

        if (password !== confirmPassword) {
            statusMsg.textContent = '‚ùå Passwords do not match';
            statusMsg.style.color = '#ef4444';
            return;
        }

        if (password.length < 6) {
            statusMsg.textContent = '‚ùå Password must be at least 6 characters';
            statusMsg.style.color = '#ef4444';
            return;
        }

        if (!termsAccepted) {
            statusMsg.textContent = '‚ùå Please accept the Terms of Service';
            statusMsg.style.color = '#ef4444';
            return;
        }

        // Disable button
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating account...';
        statusMsg.textContent = '‚è≥ Creating your account...';
        statusMsg.style.color = '#fbbf24';

        try {
            // Create auth account
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Update display name
            await updateProfile(user, { displayName: username });

            // Generate default referral code
            const defaultReferralCode = user.uid.slice(0, 8).toUpperCase();

            // Get referral code from session (if referred)
            const referredByCode = sessionStorage.getItem('referralCode');
            let referredBy = null;

            // Validate referral code
            if (referredByCode) {
                const referrerQuery = query(
                    collection(db, 'Users'),
                    where('referralCode', '==', referredByCode.toUpperCase())
                );
                const referrerSnapshot = await getDocs(referrerQuery);
                
                if (!referrerSnapshot.empty) {
                    referredBy = referredByCode.toUpperCase();
                }
            }

            // Create Firestore user profile
            const userData = {
                Username: username,
                Email: email,
                referralCode: defaultReferralCode,
                subscriptionStatus: "none",
                isPaid: false,
                stripeCustomerId: null,
                joinedAt: serverTimestamp(),
                lastLoginDate: serverTimestamp()
            };

            // Add referral info if valid
            if (referredBy) {
                userData.referredBy = referredBy;
                userData.referredAt = serverTimestamp();
            }

            await setDoc(doc(db, 'Users', user.uid), userData);

            // Clear referral code from session
            sessionStorage.removeItem('referralCode');

            // Success
            statusMsg.textContent = '‚úÖ Account created successfully!';
            statusMsg.style.color = '#22c55e';

            // Redirect to payment
            setTimeout(() => {
                window.location.href = 'payment.html';
            }, 1500);

        } catch (error) {
            console.error('Signup error:', error);
            
            let errorMsg = '‚ùå ';
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMsg += 'This email is already registered';
                    break;
                case 'auth/invalid-email':
                    errorMsg += 'Invalid email address';
                    break;
                case 'auth/weak-password':
                    errorMsg += 'Password is too weak';
                    break;
                default:
                    errorMsg += 'Signup failed: ' + error.message;
            }
            
            statusMsg.textContent = errorMsg;
            statusMsg.style.color = '#ef4444';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Account';
        }
    });
</script>

<style>
.referral-banner {
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(76, 29, 149, 0.2));
    border: 1px solid rgba(147, 51, 234, 0.4);
    border-radius: 12px;
    margin-bottom: 1.5rem;
}

.referral-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.referral-icon {
    font-size: 2rem;
}

.referral-content strong {
    display: block;
    color: var(--purple-light);
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
}

.referral-content p {
    color: var(--text-dim);
    font-size: 0.85rem;
    margin: 0;
}
</style>