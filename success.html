<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payment Successful | The Arcane Archives</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.firebaseapp.com https://*.googleapis.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://firestore.googleapis.com https://*.cloudfunctions.net https://*.netlify.app https://arcanearchives.shop https://api.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;">
  <link rel="icon" href="ArcaneA.png">
  <link rel="apple-touch-icon" href="ArcaneA.png">
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      background: #05030b;
      color: #f8f4ff;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
      margin: 0;
    }
    .card {
      max-width: 480px;
      width: 100%;
      border-radius: 24px;
      padding: 32px 28px;
      background: radial-gradient(circle at top, #3b16ff22, #05030b 60%);
      border: 1px solid #7b5cff44;
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
      text-align: center;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    p {
      margin: 6px 0;
      line-height: 1.5;
    }
    #payment-status {
      margin-top: 16px;
      font-weight: 600;
      color: #c2a3ff;
      min-height: 1.4em;
    }
    .btn {
      margin-top: 18px;
      display: inline-block;
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #a67bff;
      color: #05030b;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }
    .btn-secondary {
      background: transparent;
      color: #a67bff;
      border: 1px solid #a67bff99;
      margin-top: 10px;
    }
    .error-details {
      margin-top: 20px;
      padding: 15px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      color: #ef4444;
      font-size: 14px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üî• Payment Successful</h1>
    <p>Thank you for joining <strong>The Arcane Archives</strong>.</p>
    <p>We're finishing your account activation‚Ä¶</p>

    <p id="payment-status">Verifying your payment...</p>

    <a href="dashboard.html" class="btn" id="dashboard-link" style="display:none;">
      Go to your Dashboard
    </a>

    <a href="login.html" class="btn btn-secondary" id="login-link" style="display:none;">
      Click here to log in
    </a>

    <div id="error-details" class="error-details" style="display:none;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
      authDomain: "arcane-archives-3b0f5.firebaseapp.com",
      projectId: "arcane-archives-3b0f5",
      storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
      messagingSenderId: "264237235055",
      appId: "1:264237235055:web:4a2e5605b0ffb5307f069a",
      measurementId: "G-YGPLQHDXMM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const statusEl = document.getElementById("payment-status");
    const dashLink = document.getElementById("dashboard-link");
    const loginLink = document.getElementById("login-link");
    const errorDetails = document.getElementById("error-details");

    function setStatus(msg, isError = false) {
      console.log("[SUCCESS PAGE]", msg);
      if (statusEl) {
        statusEl.textContent = msg;
        if (isError) statusEl.style.color = '#ef4444';
      }
    }

    function showError(msg, details = '') {
      setStatus(msg, true);
      if (details && errorDetails) {
        errorDetails.innerHTML = `<strong>Technical Details:</strong><br>${details}`;
        errorDetails.style.display = 'block';
      }
    }

    // Get session_id from URL
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("session_id");

    if (!sessionId) {
      showError("Missing session ID in URL.", "No session_id parameter found. If you were charged, please contact support with your email address.");
      loginLink.style.display = "inline-block";
    } else {
      // Store session ID
      try {
        localStorage.setItem("aa_last_session_id", sessionId);
      } catch (e) {
        console.warn("Could not store session id in localStorage", e);
      }
    }

    // Wait for Firebase Auth user
    onAuthStateChanged(auth, async (user) => {
      // Not logged in?
      if (!user) {
        setStatus("To complete activation, please log in to your account.");
        loginLink.style.display = "inline-block";
        return;
      }

      console.log("‚úÖ User authenticated:", user.uid);

      // Get session ID
      let sid = sessionId;
      if (!sid) {
        try {
          sid = localStorage.getItem("aa_last_session_id");
        } catch (e) {
          console.warn("Could not read session id from storage", e);
        }
      }

      if (!sid) {
        showError("No payment session found.", "Session ID is missing. If you were charged, please contact support@arcane-archives.com with your email.");
        return;
      }

      try {
        setStatus("Verifying payment with Stripe...");
        console.log("Calling verify function with sessionId:", sid);

        // Call Netlify verify function
        const res = await fetch("/.netlify/functions/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId: sid }),
        });

        console.log("Verify response status:", res.status);

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          console.error("Verify error:", errorData);
          showError(
            "There was an issue verifying your payment.", 
            `Status: ${res.status}. ${errorData.error || 'Unknown error'}. Please contact support if you were charged.`
          );
          return;
        }

        const data = await res.json();
        console.log("Verify response:", data);

        const paid = data.payment_status === "paid" || data.status === "complete";

        if (!paid) {
          showError(
            "Payment not completed yet.", 
            `Payment status: ${data.payment_status}. If you were charged, please contact support.`
          );
          return;
        }

        setStatus("Payment verified! Activating your account...");
        console.log("Updating Firestore for user:", user.uid);

        // Mark user as paid in Firestore - USING "Users" (capital U)
        await setDoc(
          doc(db, "Users", user.uid),
          {
            isPaid: true,
            subscriptionStatus: "active",
            stripeCustomerId: data.customer || null,
            stripeSubscriptionId: data.subscription || null,
          },
          { merge: true }
        );

        console.log("‚úÖ Firestore updated successfully");
        setStatus("‚úÖ Your account has been activated! Welcome to The Arcane Archives üîÆ");
        dashLink.style.display = "inline-block";

        // Clear stored session
        try {
          localStorage.removeItem("aa_last_session_id");
        } catch (e) {
          console.warn("Could not clear session from storage", e);
        }

        // Auto-redirect after 3 seconds
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 3000);

      } catch (err) {
        console.error("‚ùå Error during activation:", err);
        showError(
          "Unexpected error verifying your payment.", 
          `Error: ${err.message}. Please contact support@arcane-archives.com if this persists.`
        );
      }
    });
  </script>
</body>
</html>