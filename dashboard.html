<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | The Arcane Archives</title>
  <link rel="icon" href="ArcaneA.png" />

<style>
  * { margin:0; padding:0; box-sizing:border-box; }

  body{
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: radial-gradient(circle at top, #111827, #02010a 60%, #000);
    color:#e5e5e5;
    min-height:100vh;
  }

  .container{ max-width:1200px; margin:0 auto; padding:2rem 1.5rem 4rem; }

  .header{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:2rem; flex-wrap:wrap; gap:1rem;
  }

  .logo{
    display:flex; align-items:center; gap:.7rem;
    font-weight:800; letter-spacing:.1em; font-size:.85rem;
  }
  .logo img{ width:32px; height:32px; }

  .logout{
    cursor:pointer; color:#ef4444; font-size:.85rem;
    padding:.5rem 1rem; border-radius:10px;
    border:1px solid rgba(239,68,68,.3);
    transition:all .2s;
  }
  .logout:hover{ background:rgba(239,68,68,.1); border-color:#ef4444; }

  .welcome-card{
    background: radial-gradient(circle at top, rgba(147,51,234,.16), rgba(15,23,42,.98));
    border-radius:20px;
    border:1px solid rgba(148,163,184,.35);
    padding:2rem;
    margin-bottom:1.2rem;
  }

  .welcome-card h1{ font-size:2rem; margin-bottom:.5rem; }
  .welcome-card p{ color:#a3a3a3; font-size:1rem; }

  .balance-card{
    margin-top:1.2rem;
    padding:1.2rem 1.2rem;
    border-radius:16px;
    border:1px solid rgba(148,163,184,.28);
    background: rgba(2,6,23,.35);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:1rem;
  }

  .balance-left .label{
    font-size:.75rem; letter-spacing:.12em; text-transform:uppercase;
    color:#9ca3af; font-weight:800;
    margin-bottom:.35rem;
  }

  .balance-amount{
    font-size:1.8rem;
    font-weight:900;
    color:#fbbf24;
    line-height:1.05;
    display:inline-flex;
    align-items:baseline;
    gap:.5rem;
  }

  .balance-amount .pulse{
    display:inline-block;
    width:10px; height:10px;
    border-radius:999px;
    background: rgba(34,197,94,.9);
    box-shadow: 0 0 0 rgba(34,197,94,.0);
    opacity:0;
    transform: translateY(-2px);
  }

  .balance-sub{
    color:#a3a3a3;
    font-size:.9rem;
    margin-top:.35rem;
    line-height:1.4;
  }

  .balance-actions{
    display:flex;
    gap:.75rem;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .btn{
    border:none;
    cursor:pointer;
    font-weight:900;
    border-radius:999px;
    padding:.65rem 1rem;
    font-size:.85rem;
    transition: all .15s ease;
    white-space:nowrap;
  }

  .btn-primary{
    background: linear-gradient(135deg, #9333ea, #7e22ce);
    color:white;
    border:1px solid rgba(167,139,250,.35);
  }
  .btn-primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 25px rgba(147,51,234,.35); }

  .btn-secondary{
    background: rgba(0,0,0,.25);
    color:#e5e5e5;
    border:1px solid rgba(148,163,184,.28);
  }
  .btn-secondary:hover{ transform: translateY(-1px); border-color: rgba(167,139,250,.55); }

  /* TradingView */
  .tv-ticker-wrap{
    border-radius:16px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    background:#000; /* TRUE BLACK */
    padding:6px 0;
    margin-bottom:2rem;
  }
  /* make attribution subtle (cannot remove) */
  .tv-ticker-wrap a, .tv-ticker-wrap span{
    opacity:.7;
    font-size:.72rem;
  }

  /* Core features cards (simple) */
  .section-title{
    margin:1.5rem 0 1rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#a78bfa;
    font-weight:900;
    font-size:.85rem;
    display:flex;
    align-items:center;
    gap:.5rem;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap:1rem;
    margin-bottom:1.5rem;
  }

  .card{
    border-radius:16px;
    border:1px solid rgba(251,191,36,.28);
    background: rgba(15,23,42,.90);
    padding:1rem;
    min-height:78px;
    display:flex;
    gap:.75rem;
    align-items:center;
    cursor:pointer;
    transition: all .15s ease;
  }
  .card:hover{
    transform: translateY(-2px);
    border-color: rgba(251,191,36,.55);
    box-shadow: 0 18px 35px rgba(0,0,0,.35);
  }

  .card .icon{ font-size:1.4rem; width:34px; text-align:center; }
  .card .title{ font-weight:900; }
  .card .desc{ color:#9ca3af; font-size:.85rem; margin-top:.1rem; }

  /* Modal */
  .modal-overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.75);
    display:none;
    z-index:2000;
  }
  .modal-overlay.active{ display:block; }

  .modal{
    position:fixed;
    left:50%; top:50%;
    transform: translate(-50%, -50%);
    width:min(680px, 92vw);
    background: rgba(15,23,42,.98);
    border:1px solid rgba(148,163,184,.28);
    border-radius:18px;
    z-index:2100;
    display:none;
    overflow:hidden;
  }
  .modal.active{ display:block; }

  .modal-head{
    padding:1.1rem 1.2rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid rgba(148,163,184,.18);
  }
  .modal-head h3{
    font-size:1rem;
    letter-spacing:.1em;
    text-transform:uppercase;
    color:#a78bfa;
    font-weight:900;
  }
  .modal-close{
    width:38px; height:38px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.25);
    background: rgba(0,0,0,.25);
    color:#e5e5e5;
    cursor:pointer;
    font-size:1.2rem;
  }

  .modal-body{
    padding:1rem 1.2rem 1.2rem;
    max-height: 70vh;
    overflow:auto;
  }

  .tx{
    padding:.85rem .8rem;
    border:1px solid rgba(148,163,184,.18);
    border-radius:14px;
    background: rgba(0,0,0,.22);
    display:flex;
    justify-content:space-between;
    gap:1rem;
    margin-bottom:.75rem;
  }
  .tx .left{ min-width:0; }
  .tx .type{ font-weight:900; }
  .tx .meta{ color:#9ca3af; font-size:.85rem; margin-top:.15rem; line-height:1.3; }
  .tx .amt{ font-weight:900; }
  .tx .amt.pos{ color:#22c55e; }
  .tx .amt.neg{ color:#f87171; }

  .empty{
    color:#9ca3af;
    text-align:center;
    padding:2rem 1rem;
    line-height:1.6;
  }

  /* Mobile fixes */
  @media (max-width: 980px){
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  @media (max-width: 860px){
    .balance-card{
      flex-direction:column;
      align-items:stretch;
    }
    .balance-actions{
      width:100%;
      justify-content:flex-start;
    }
  }

  @media (max-width: 640px){
    .container{ padding: 1.5rem 1rem 3rem; }
    .welcome-card{ padding:1.4rem; }
    .welcome-card h1{ font-size:1.5rem; }

    .balance-card{
      flex-direction:column;
      align-items:flex-start;
      gap:12px;
    }
    .balance-actions{
      width:100%;
      display:flex;
      gap:10px;
      justify-content:space-between;
    }
  }
</style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img src="ArcaneA.png" alt="Arcane" />
        THE ARCANE ARCHIVES
      </div>
      <div class="logout" id="logoutBtn">üö™ Log out</div>
    </div>

    <div class="welcome-card">
      <h1 id="welcomeTitle">Welcome back üëã</h1>
      <p>Your command center for mastering the game</p>

      <div class="balance-card">
        <div class="balance-left">
          <div class="label">ACCOUNT BALANCE</div>
          <div class="balance-amount">
            <span id="accountBalance">¬£0.00</span>
            <span class="pulse" id="balancePulse"></span>
          </div>
          <div class="balance-sub">Earn commissions in Referrals. Spend them in Arcane Store.</div>
        </div>

        <div class="balance-actions">
          <button class="btn btn-primary" id="shopWithBalanceBtn">üõçÔ∏è Shop with Balance</button>
          <button class="btn btn-secondary" id="viewTxBtn">üßæ Balance History</button>
          <button class="btn btn-secondary" id="viewEarningsBtn">üí∏ View Earnings</button>
        </div>
      </div>
    </div>

    <!-- TradingView Ticker Tape -->
    <div class="tv-ticker-wrap">
      <script type="module" src="https://widgets.tradingview-widget.com/w/en/tv-ticker-tape.js"></script>
      <tv-ticker-tape
        symbols="CMCMARKETS:GOLD,OANDA:XAGUSD,BITSTAMP:BTCUSD,VANTAGE:SP500,BITSTAMP:ETHUSD"
        item-size="compact"
        theme="dark"
        show-hover>
      </tv-ticker-tape>
    </div>

    <div class="section-title">üî• CORE FEATURES</div>
    <div class="grid">
      <div class="card" onclick="location.href='courses.html'">
        <div class="icon">üìö</div>
        <div>
          <div class="title">The Arcane Archives</div>
          <div class="desc">Full access Courses</div>
        </div>
      </div>

      <div class="card" onclick="location.href='alerts.html'">
        <div class="icon">üìà</div>
        <div>
          <div class="title">Arcane Alerts</div>
          <div class="desc">Real-time Alerts</div>
        </div>
      </div>

      <div class="card" onclick="location.href='live-calls.html'">
        <div class="icon">üéôÔ∏è</div>
        <div>
          <div class="title">Live Calls</div>
          <div class="desc">Weekly Education Calls</div>
        </div>
      </div>

      <div class="card" onclick="location.href='stock-picks.html'">
        <div class="icon">üíº</div>
        <div>
          <div class="title">Stock Picks</div>
          <div class="desc">Long Term investments</div>
        </div>
      </div>

      <div class="card" onclick="location.href='referrals.html'">
        <div class="icon">üéØ</div>
        <div>
          <div class="title">Referrals Program</div>
          <div class="desc">¬£25/month per referral</div>
        </div>
      </div>

      <div class="card" onclick="location.href='arcane-store.html'">
        <div class="icon">üõçÔ∏è</div>
        <div>
          <div class="title">Arcane Store</div>
          <div class="desc">Exclusive branded merch</div>
        </div>
      </div>

      <div class="card" style="opacity:.65; cursor:not-allowed;">
        <div class="icon">üå¥</div>
        <div>
          <div class="title">The Retreat</div>
          <div class="desc">Coming 2028</div>
        </div>
      </div>
    </div>

    <div class="section-title">üõ†Ô∏è ADMIN TOOLS</div>
    <div class="grid">
      <div class="card" onclick="location.href='admin-panel.html'">
        <div class="icon">üõ†Ô∏è</div>
        <div>
          <div class="title">Admin Panel</div>
          <div class="desc">Manage stocks & alerts</div>
        </div>
      </div>

      <div class="card" onclick="location.href='affiliate-admin.html'">
        <div class="icon">üí∏</div>
        <div>
          <div class="title">Affiliate Admin</div>
          <div class="desc">Process withdrawals</div>
        </div>
      </div>

      <div class="card" onclick="location.href='store-admin.html'">
        <div class="icon">üõçÔ∏è</div>
        <div>
          <div class="title">Store Admin</div>
          <div class="desc">Manage products</div>
        </div>
      </div>

      <div class="card" onclick="location.href='store-orders.html'">
        <div class="icon">üì¶</div>
        <div>
          <div class="title">Store Orders</div>
          <div class="desc">View & fulfill orders</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Balance TX modal -->
  <div class="modal-overlay" id="txOverlay"></div>
  <div class="modal" id="txModal">
    <div class="modal-head">
      <h3>Balance History</h3>
      <button class="modal-close" id="txCloseBtn">√ó</button>
    </div>
    <div class="modal-body" id="txBody">
      <div class="empty">Loading‚Ä¶</div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
  import { getFirestore, doc, getDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
    authDomain: "arcane-archives-3b0f5.firebaseapp.com",
    projectId: "arcane-archives-3b0f5",
    storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
    messagingSenderId: "264237235055",
    appId: "1:264237235055:web:4a2e5605b0ffb5307f069a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const accountBalanceEl = document.getElementById('accountBalance');
  const pulseEl = document.getElementById('balancePulse');

  const txOverlay = document.getElementById('txOverlay');
  const txModal = document.getElementById('txModal');
  const txBody = document.getElementById('txBody');
  const txCloseBtn = document.getElementById('txCloseBtn');
  const viewTxBtn = document.getElementById('viewTxBtn');
  const shopWithBalanceBtn = document.getElementById('shopWithBalanceBtn');
  const viewEarningsBtn = document.getElementById('viewEarningsBtn');

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
    location.href = 'login.html';
  });

  shopWithBalanceBtn.addEventListener('click', () => location.href = 'arcane-store.html');
  viewEarningsBtn.addEventListener('click', () => location.href = 'referrals.html');

  function moneyGBP(n){
    const x = Number(n||0);
    return `¬£${x.toFixed(2)}`;
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function animateNumber(from, to, ms=800){
    const start = performance.now();
    const f = Number(from||0);
    const t = Number(to||0);
    const step = (now) => {
      const p = Math.min(1, (now - start) / ms);
      const val = f + (t - f) * (1 - Math.pow(1 - p, 3));
      accountBalanceEl.textContent = moneyGBP(val);
      if (p < 1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }

  function pulse(){
    pulseEl.style.opacity = '1';
    pulseEl.animate(
      [
        { transform: 'scale(1)', boxShadow:'0 0 0 rgba(34,197,94,0)' },
        { transform: 'scale(1.35)', boxShadow:'0 0 18px rgba(34,197,94,.55)' },
        { transform: 'scale(1)', boxShadow:'0 0 0 rgba(34,197,94,0)' }
      ],
      { duration: 900, easing: 'ease-out' }
    );
    setTimeout(()=>{ pulseEl.style.opacity='0'; }, 900);
  }

  function openTx(){
    txOverlay.classList.add('active');
    txModal.classList.add('active');
  }

  function closeTx(){
    txOverlay.classList.remove('active');
    txModal.classList.remove('active');
  }

  txOverlay.addEventListener('click', closeTx);
  txCloseBtn.addEventListener('click', closeTx);
  viewTxBtn.addEventListener('click', async () => {
    openTx();
    await loadTransactions();
  });

  async function loadTransactions(){
    try{
      txBody.innerHTML = `<div class="empty">Loading‚Ä¶</div>`;

      // Primary: BalanceTransactions
      const q1 = query(
        collection(db, 'BalanceTransactions'),
        where('userId', '==', auth.currentUser.uid),
        orderBy('createdAt', 'desc'),
        limit(30)
      );

      const snap = await getDocs(q1);
      if (!snap.empty){
        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

        txBody.innerHTML = rows.map(tx => {
          const dt = tx.createdAt?.toDate?.() ? tx.createdAt.toDate() : null;
          const when = dt ? dt.toLocaleString() : '‚Äî';
          const amt = Number(tx.amount || 0);
          const cls = amt >= 0 ? 'pos' : 'neg';
          const sign = amt >= 0 ? '+' : '‚àí';

          return `
            <div class="tx">
              <div class="left">
                <div class="type">${escapeHtml(tx.type || 'balance')}</div>
                <div class="meta">${escapeHtml(tx.note || '')}<br>${escapeHtml(when)}</div>
              </div>
              <div class="amt ${cls}">${sign}${Math.abs(amt).toFixed(2)} GBP</div>
            </div>
          `;
        }).join('');
        return;
      }

      // Fallback: CommissionHistory (existing)
      const q2 = query(
        collection(db, 'CommissionHistory'),
        where('affiliateId', '==', auth.currentUser.uid),
        orderBy('createdAt', 'desc'),
        limit(30)
      );

      const snap2 = await getDocs(q2);
      if (snap2.empty){
        txBody.innerHTML = `
          <div class="empty">
            No transactions yet.<br>
            When commissions land or you spend balance, they‚Äôll show here.
          </div>
        `;
        return;
      }

      const rows2 = [];
      snap2.forEach(d => rows2.push({ id: d.id, ...d.data() }));

      txBody.innerHTML = rows2.map(tx => {
        const dt = tx.createdAt?.toDate?.() ? tx.createdAt.toDate() : null;
        const when = dt ? dt.toLocaleString() : '‚Äî';
        const amt = Number(tx.amount || 0);
        const cls = amt >= 0 ? 'pos' : 'neg';
        const sign = amt >= 0 ? '+' : '‚àí';

        return `
          <div class="tx">
            <div class="left">
              <div class="type">${escapeHtml(tx.type || 'commission')}</div>
              <div class="meta">${escapeHtml(tx.note || '')}<br>${escapeHtml(when)}</div>
            </div>
            <div class="amt ${cls}">${sign}${Math.abs(amt).toFixed(2)} GBP</div>
          </div>
        `;
      }).join('');

    } catch(err){
      console.error(err);
      txBody.innerHTML = `<div class="empty">Couldn‚Äôt load transactions.</div>`;
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user){
      location.href = 'login.html';
      return;
    }

    // Welcome name (from Users doc if exists)
    try{
      const uref = doc(db, 'Users', user.uid);
      const usnap = await getDoc(uref);
      const uname = usnap.exists() ? (usnap.data().Username || usnap.data().username || '') : '';
      document.getElementById('welcomeTitle').textContent = uname
        ? `Welcome back, ${uname} üëã`
        : `Welcome back üëã`;
    }catch{}

    // Live balance listener (Affiliates doc)
    const aref = doc(db, 'Affiliates', user.uid);
    let last = null;

    onSnapshot(aref, (snap) => {
      if (!snap.exists()){
        accountBalanceEl.textContent = moneyGBP(0);
        last = 0;
        return;
      }

      const d = snap.data();

      // Support both schemas (availableBalance OR balance)
      const current = Number(d.availableBalance ?? d.balance ?? 0);

      if (last === null){
        accountBalanceEl.textContent = moneyGBP(current);
        last = current;
        return;
      }

      if (current > last){
        animateNumber(last, current, 850);
        pulse();
      } else {
        animateNumber(last, current, 550);
      }

      last = current;
    });
  });
</script>
</body>
</html>
