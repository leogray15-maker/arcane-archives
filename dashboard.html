<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | The Arcane Archives</title>
  <link rel="icon" href="ArcaneA.png" />

  <style>
    :root{
      --bg1:#111827;
      --bg2:#02010a;
      --bg3:#000;
      --border: rgba(148,163,184,.28);
      --gold: #fbbf24;
      --purple: #9333ea;
      --purple2:#7e22ce;
      --purpleLight:#a78bfa;
      --text:#e5e5e5;
      --muted:#9ca3af;
      --danger:#ef4444;
      --success:#22c55e;
    }

    *{ margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, var(--bg1), var(--bg2) 60%, var(--bg3));
      color: var(--text);
      min-height: 100vh;
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    /* Header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 1rem;
      flex-wrap:wrap;
      margin-bottom: 1.6rem;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:.7rem;
      font-weight: 900;
      letter-spacing: .12em;
      font-size: .85rem;
      text-transform: uppercase;
    }
    .brand img{ width: 32px; height: 32px; border-radius: 8px; }

    .header-actions{
      display:flex;
      gap: .75rem;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill-btn{
      cursor:pointer;
      border-radius: 999px;
      padding: .6rem 1rem;
      font-weight: 900;
      font-size: .85rem;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--text);
      transition: all .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      white-space:nowrap;
    }
    .pill-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(167,139,250,.55);
    }

    .logout{
      border-color: rgba(239,68,68,.35);
      color: var(--danger);
    }
    .logout:hover{
      border-color: rgba(239,68,68,.7);
      background: rgba(239,68,68,.08);
    }

    /* Welcome */
    .welcome{
      background: radial-gradient(circle at top, rgba(147,51,234,.16), rgba(15,23,42,.98));
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 1.1rem;
    }
    .welcome h1{
      font-size: 2rem;
      margin-bottom: .5rem;
    }
    .welcome p{
      color: var(--muted);
      line-height: 1.5;
    }

    /* Balance card */
    .balance-card{
      margin-top: 1.2rem;
      padding: 1.2rem 1.2rem;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.28);
      background: rgba(2,6,23,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 1rem;
    }

    .balance-left .label{
      font-size:.75rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      font-weight: 900;
      margin-bottom:.35rem;
    }

    .balance-amount{
      font-size: 1.85rem;
      font-weight: 900;
      color: var(--gold);
      line-height: 1.05;
      display: inline-flex;
      align-items: baseline;
      gap: .55rem;
    }

    .pulse-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(34,197,94,.9);
      opacity: 0;
      transform: translateY(-2px);
    }

    .balance-sub{
      color: var(--muted);
      font-size: .9rem;
      margin-top: .35rem;
      line-height: 1.4;
    }

    .balance-actions{
      display:flex;
      gap: .75rem;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      cursor:pointer;
      font-weight: 900;
      border-radius: 999px;
      padding: .65rem 1rem;
      font-size: .85rem;
      transition: all .15s ease;
      white-space:nowrap;
    }

    .btn-primary{
      background: linear-gradient(135deg, var(--purple), var(--purple2));
      color: #fff;
      border: 1px solid rgba(167,139,250,.35);
    }
    .btn-primary:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(147,51,234,.32);
    }

    .btn-secondary{
      background: rgba(0,0,0,.22);
      color: var(--text);
      border: 1px solid rgba(148,163,184,.28);
    }
    .btn-secondary:hover{
      transform: translateY(-1px);
      border-color: rgba(167,139,250,.55);
    }

    /* TradingView ticker */
    .tv-ticker-wrap{
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: #000;
      padding: 6px 0;
      margin: 0 0 1.6rem;
    }
    .tv-ticker-wrap a,
    .tv-ticker-wrap span{
      opacity: .7;
      font-size: .72rem;
    }

    /* Section headings */
    .section-title{
      margin: 1.5rem 0 1rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--purpleLight);
      font-weight: 900;
      font-size: .85rem;
      display:flex;
      align-items:center;
      gap:.55rem;
    }

    /* Tiles */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 1.35rem;
    }

    .tile{
      border-radius: 16px;
      border: 1px solid rgba(251,191,36,.28);
      background: rgba(15,23,42,.90);
      padding: 1rem;
      min-height: 84px;
      display:flex;
      gap: .75rem;
      align-items:center;
      cursor:pointer;
      transition: all .15s ease;
      position: relative;
      overflow: hidden;
    }

    .tile:hover{
      transform: translateY(-2px);
      border-color: rgba(251,191,36,.55);
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
    }

    .tile-icon{
      width: 40px;
      text-align:center;
      font-size: 1.35rem;
      opacity: .95;
      flex: 0 0 auto;
    }

    .tile-content{ 
      min-width: 0; 
      flex: 1;
    }
    .tile-title{ 
      font-weight: 900;
      line-height: 1.3;
    }
    .tile-desc{
      color: var(--muted);
      font-size: .85rem;
      margin-top: .15rem;
      line-height: 1.25;
    }

    /* Lock badge - optimized for mobile */
    .tile.locked::after{
      content:"üîí Members";
      position:absolute;
      right: 5px;
      top: 5px;
      font-size: .62rem;
      font-weight: 900;
      letter-spacing: .05em;
      text-transform: uppercase;
      padding: .22rem .45rem;
      border-radius: 999px;
      border: 1px solid rgba(167,139,250,.25);
      background: rgba(0,0,0,.75);
      color: var(--purpleLight);
      white-space: nowrap;
      pointer-events: none;
      z-index: 1;
    }

    /* Give locked tiles padding so content doesn't overlap badge */
    .tile.locked .tile-content{
      padding-right: 82px;
    }

    /* Locked Access Modal */
    .locked-modal-overlay{
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(4px);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
    }
    .locked-modal-overlay.active{
      opacity: 1;
      pointer-events: all;
    }

    .locked-modal{
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(.92);
      z-index: 9999;
      background: linear-gradient(135deg, rgba(15,23,42,.98), rgba(17,24,39,.98));
      border: 1px solid rgba(167,139,250,.45);
      border-radius: 20px;
      padding: 2rem;
      max-width: 480px;
      width: calc(100% - 2rem);
      opacity: 0;
      pointer-events: none;
      transition: all .25s ease;
      box-shadow: 0 25px 50px rgba(0,0,0,.6);
    }
    .locked-modal.active{
      opacity: 1;
      pointer-events: all;
      transform: translate(-50%, -50%) scale(1);
    }

    .locked-modal-icon{
      font-size: 3.5rem;
      text-align: center;
      margin-bottom: 1rem;
      line-height: 1;
    }

    .locked-modal h3{
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: .75rem;
      color: var(--purpleLight);
    }

    .locked-modal p{
      text-align: center;
      color: var(--muted);
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .locked-modal-actions{
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
    }

    .locked-modal-actions .btn{
      flex: 1;
      min-width: 140px;
      justify-content: center;
      text-align: center;
    }

    /* Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      z-index: 2000;
    }
    .modal-overlay.active{ display:block; }

    .modal{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width: min(680px, 92vw);
      background: rgba(15,23,42,.98);
      border: 1px solid rgba(148,163,184,.28);
      border-radius: 18px;
      z-index: 2100;
      display:none;
      overflow:hidden;
    }
    .modal.active{ display:block; }

    .modal-head{
      padding: 1.05rem 1.2rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(148,163,184,.18);
    }
    .modal-head h3{
      font-size: 1rem;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--purpleLight);
      font-weight: 900;
    }
    .modal-close{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      font-size: 1.2rem;
    }

    .modal-body{
      padding: 1rem 1.2rem 1.2rem;
      max-height: 70vh;
      overflow:auto;
    }

    .tx{
      padding:.85rem .8rem;
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      display:flex;
      justify-content:space-between;
      gap: 1rem;
      margin-bottom: .75rem;
    }
    .tx .left{ min-width:0; }
    .tx .type{ font-weight: 900; }
    .tx .meta{
      color: var(--muted);
      font-size: .85rem;
      margin-top: .15rem;
      line-height: 1.3;
      white-space: pre-line;
    }
    .tx .amt{ font-weight: 900; }
    .tx .amt.pos{ color: var(--success); }
    .tx .amt.neg{ color: #f87171; }

    .empty{
      color: var(--muted);
      text-align:center;
      padding: 2rem 1rem;
      line-height: 1.6;
    }

    /* Responsive */
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 860px){
      .balance-card{
        flex-direction:column;
        align-items:stretch;
      }
      .balance-actions{
        width:100%;
        justify-content:flex-start;
      }
    }

    @media (max-width: 640px){
      .container{ padding: 1.5rem 1rem 3rem; }
      .welcome{ padding: 1.4rem; }
      .welcome h1{ font-size: 1.55rem; }

      .balance-card{
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .balance-actions{
        width: 100%;
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .balance-actions .btn{
        flex: 1 1 auto;
        min-width: 140px;
        text-align:center;
      }

      /* Smaller badge on mobile */
      .tile.locked::after{
        font-size: .6rem;
        padding: .2rem .42rem;
        right: 4px;
        top: 4px;
        letter-spacing: .04em;
      }

      .tile.locked .tile-content{
        padding-right: 78px;
      }

      .tile{
        padding: .9rem;
      }

      /* Locked modal mobile optimizations */
      .locked-modal{
        padding: 1.5rem;
        width: calc(100% - 2rem);
        max-width: 400px;
      }

      .locked-modal-icon{
        font-size: 3rem;
        margin-bottom: .8rem;
      }

      .locked-modal h3{
        font-size: 1.35rem;
      }

      .locked-modal p{
        font-size: .95rem;
        margin-bottom: 1.25rem;
      }

      .locked-modal-actions{
        flex-direction: column;
      }

      .locked-modal-actions .btn{
        width: 100%;
        min-width: 0;
      }
    }

    @media (max-width: 420px){
      .tile-icon{
        font-size: 1.2rem;
        width: 36px;
      }

      .tile-title{
        font-size: .95rem;
      }

      .tile-desc{
        font-size: .8rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <img src="ArcaneA.png" alt="Arcane" />
        THE ARCANE ARCHIVES
      </div>

      <div class="header-actions">
        <a class="pill-btn" href="settings.html">‚öôÔ∏è Settings</a>
        <button class="pill-btn logout" id="logoutBtn">üö™ Log out</button>
      </div>
    </div>

    <div class="welcome">
      <h1 id="welcomeTitle">Welcome back üëã</h1>
      <p>Your command center for mastering the game</p>

      <div class="balance-card">
        <div class="balance-left">
          <div class="label">ACCOUNT BALANCE</div>
          <div class="balance-amount">
            <span id="accountBalance">¬£0.00</span>
            <span class="pulse-dot" id="balancePulse"></span>
          </div>
          <div class="balance-sub">Withdraw Commissions or spend them in The Arcane Store.</div>
        </div>

        <div class="balance-actions">
          <button class="btn btn-primary" id="shopBtn">üõçÔ∏è Store</button>
          <button class="btn btn-secondary" id="historyBtn">üßæ Balance History</button>
          <button class="btn btn-secondary" id="earningsBtn">üí∏ Referrals</button>
        </div>
      </div>
    </div>

    <!-- TradingView Ticker Tape -->
    <div class="tv-ticker-wrap">
      <script type="module" src="https://widgets.tradingview-widget.com/w/en/tv-ticker-tape.js"></script>
      <tv-ticker-tape
        symbols="CMCMARKETS:GOLD,OANDA:XAGUSD,BITSTAMP:BTCUSD,VANTAGE:SP500,BITSTAMP:ETHUSD"
        item-size="compact"
        theme="dark"
        show-hover>
      </tv-ticker-tape>
    </div>

    <!-- CORE FEATURES -->
    <div class="section-title">üî• Core Features</div>
    <div class="grid" id="coreGrid">

      <div class="tile" data-paid="true" data-href="notion-invite.html">
        <div class="tile-icon">üìö</div>
        <div class="tile-content">
          <div class="tile-title">Archives</div>
          <div class="tile-desc">Notion Courses / Modules</div>
        </div>
      </div>

      <div class="tile" data-paid="true" data-href="alerts.html">
        <div class="tile-icon">üìà</div>
        <div class="tile-content">
          <div class="tile-title">Arcane Trading Floor</div>
          <div class="tile-desc">Real-time alerts</div>
        </div>
      </div>

      <div class="tile" data-paid="true" data-href="live-calls.html">
        <div class="tile-icon">üéôÔ∏è</div>
        <div class="tile-content">
          <div class="tile-title">Live Calls</div>
          <div class="tile-desc">Weekly education calls</div>
        </div>
      </div>

      <div class="tile" data-paid="true" data-href="stock-picks.html">
        <div class="tile-icon">üíº</div>
        <div class="tile-content">
          <div class="tile-title">Stock Picks</div>
          <div class="tile-desc">Long-term investments</div>
        </div>
      </div>

      <div class="tile" data-paid="true" data-href="arcane-store.html">
        <div class="tile-icon">üõçÔ∏è</div>
        <div class="tile-content">
          <div class="tile-title">Store</div>
          <div class="tile-desc">Exclusive merch</div>
        </div>
      </div>

    </div>

    <!-- ADMIN TOOLS (completely hidden for non-admin) -->
    <div id="adminSection" style="display:none;">
      <div class="section-title">üõ†Ô∏è Admin Tools</div>
      <div class="grid" id="adminGrid">
        <div class="tile" data-admin="true" data-href="admin-panel.html">
          <div class="tile-icon">üõ†Ô∏è</div>
          <div class="tile-content">
            <div class="tile-title">Admin Trades & Stocks</div>
            <div class="tile-desc">Manage trades & alerts</div>
          </div>
        </div>

        <div class="tile" data-admin="true" data-href="affiliate-admin.html">
          <div class="tile-icon">üí∏</div>
          <div class="tile-content">
            <div class="tile-title">Affiliate Admin</div>
            <div class="tile-desc">Withdrawals & payouts</div>
          </div>
        </div>

        <div class="tile" data-admin="true" data-href="store-admin.html">
          <div class="tile-icon">üõçÔ∏è</div>
          <div class="tile-content">
            <div class="tile-title">Store Admin</div>
            <div class="tile-desc">Products & inventory</div>
          </div>
        </div>

        <div class="tile" data-admin="true" data-href="bullion-admin.html">
          <div class="tile-icon">ü™ô</div>
          <div class="tile-content">
            <div class="tile-title">Bullion Admin</div>
            <div class="tile-desc">Manage bullion listings</div>
          </div>
        </div>
      </div>
    </div>

    <!-- FREE ACCESS -->
    <div class="section-title">üÜì Free Access</div>
    <div class="grid">
      <div class="tile" data-href="referrals.html">
        <div class="tile-icon">üéØ</div>
        <div class="tile-content">
          <div class="tile-title">Referrals</div>
          <div class="tile-desc">Earn monthly commission</div>
        </div>
      </div>

      <div class="tile" data-href="bullion.html">
        <div class="tile-icon">ü™ô</div>
        <div class="tile-content">
          <div class="tile-title">Bullion</div>
          <div class="tile-desc">Gold / Silver products</div>
        </div>
      </div>

      <div class="tile" data-href="free-signals.html">
        <div class="tile-icon">üß≤</div>
        <div class="tile-content">
          <div class="tile-title">Free Signals</div>
          <div class="tile-desc">Starter access</div>
        </div>
      </div>

      <div class="tile" data-href="live-streams.html">
        <div class="tile-icon">üì∫</div>
        <div class="tile-content">
          <div class="tile-title">Live Streams</div>
          <div class="tile-desc">Public streams</div>
        </div>
      </div>

      <div class="tile" data-href="journey.html">
        <div class="tile-icon">üß≠</div>
        <div class="tile-content">
          <div class="tile-title">Leo's Journey</div>
          <div class="tile-desc">Updates & progress</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Balance History Modal -->
  <div class="modal-overlay" id="txOverlay"></div>
  <div class="modal" id="txModal">
    <div class="modal-head">
      <h3>Balance History</h3>
      <button class="modal-close" id="txCloseBtn">√ó</button>
    </div>
    <div class="modal-body" id="txBody">
      <div class="empty">Loading‚Ä¶</div>
    </div>
  </div>

  <!-- Locked Access Modal -->
  <div class="locked-modal-overlay" id="lockedOverlay"></div>
  <div class="locked-modal" id="lockedModal">
    <div class="locked-modal-icon">üîí</div>
    <h3>Members Only</h3>
    <p>This feature is exclusive to Arcane Archives members. Upgrade now to unlock full access to all courses, live trading floor, weekly calls, and more.</p>
    <div class="locked-modal-actions">
      <button class="btn btn-secondary" id="lockedCloseBtn">Close</button>
      <button class="btn btn-primary" id="enterArchivesBtn">Enter The Arcane Archives</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
      authDomain: "arcane-archives-3b0f5.firebaseapp.com",
      projectId: "arcane-archives-3b0f5",
      storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
      messagingSenderId: "264237235055",
      appId: "1:264237235055:web:4a2e5605b0ffb5307f069a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_UIDS = new Set([
      "U4PvQ0dilBco97hgXp3Awl45JX92",
      "gefruLBk5qMXDZGmWdSo6wPNo3E3"
    ]);

    const accountBalanceEl = document.getElementById("accountBalance");
    const pulseEl = document.getElementById("balancePulse");
    const welcomeTitle = document.getElementById("welcomeTitle");

    const shopBtn = document.getElementById("shopBtn");
    const historyBtn = document.getElementById("historyBtn");
    const earningsBtn = document.getElementById("earningsBtn");

    const txOverlay = document.getElementById("txOverlay");
    const txModal = document.getElementById("txModal");
    const txBody = document.getElementById("txBody");
    const txCloseBtn = document.getElementById("txCloseBtn");

    const lockedOverlay = document.getElementById("lockedOverlay");
    const lockedModal = document.getElementById("lockedModal");
    const lockedCloseBtn = document.getElementById("lockedCloseBtn");
    const enterArchivesBtn = document.getElementById("enterArchivesBtn");

    const adminSection = document.getElementById("adminSection");

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      location.href = "login.html";
    });

    shopBtn.addEventListener("click", () => location.href = "arcane-store.html");
    earningsBtn.addEventListener("click", () => location.href = "referrals.html");

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function moneyGBP(n){
      const x = Number(n || 0);
      return `¬£${x.toFixed(2)}`;
    }

    function animateNumber(from, to, ms=800){
      const start = performance.now();
      const f = Number(from || 0);
      const t = Number(to || 0);

      const step = (now) => {
        const p = Math.min(1, (now - start) / ms);
        const eased = 1 - Math.pow(1 - p, 3);
        const val = f + (t - f) * eased;
        accountBalanceEl.textContent = moneyGBP(val);
        if (p < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function pulse(){
      pulseEl.style.opacity = "1";
      pulseEl.animate(
        [
          { transform:"scale(1)", boxShadow:"0 0 0 rgba(34,197,94,0)" },
          { transform:"scale(1.35)", boxShadow:"0 0 18px rgba(34,197,94,.55)" },
          { transform:"scale(1)", boxShadow:"0 0 0 rgba(34,197,94,0)" }
        ],
        { duration: 900, easing:"ease-out" }
      );
      setTimeout(() => { pulseEl.style.opacity = "0"; }, 900);
    }

    function openTx(){
      txOverlay.classList.add("active");
      txModal.classList.add("active");
    }
    function closeTx(){
      txOverlay.classList.remove("active");
      txModal.classList.remove("active");
    }

    function openLockedModal(){
      lockedOverlay.classList.add("active");
      lockedModal.classList.add("active");
    }
    function closeLockedModal(){
      lockedOverlay.classList.remove("active");
      lockedModal.classList.remove("active");
    }

    txOverlay.addEventListener("click", closeTx);
    txCloseBtn.addEventListener("click", closeTx);

    lockedOverlay.addEventListener("click", closeLockedModal);
    lockedCloseBtn.addEventListener("click", closeLockedModal);
    enterArchivesBtn.addEventListener("click", () => {
      location.href = "index.html#pricing";
    });

    historyBtn.addEventListener("click", async () => {
      openTx();
      await loadTransactions();
    });

    async function loadTransactions(){
      try{
        txBody.innerHTML = `<div class="empty">Loading‚Ä¶</div>`;

        const q1 = query(
          collection(db, "BalanceTransactions"),
          where("userId", "==", auth.currentUser.uid),
          orderBy("createdAt", "desc"),
          limit(30)
        );

        const snap = await getDocs(q1);
        if (!snap.empty){
          const rows = [];
          snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

          txBody.innerHTML = rows.map(tx => {
            const dt = tx.createdAt?.toDate?.() ? tx.createdAt.toDate() : null;
            const when = dt ? dt.toLocaleString() : "‚Äî";
            const amt = Number(tx.amount || 0);
            const cls = amt >= 0 ? "pos" : "neg";
            const sign = amt >= 0 ? "+" : "‚àí";

            return `
              <div class="tx">
                <div class="left">
                  <div class="type">${escapeHtml(tx.type || "balance")}</div>
                  <div class="meta">${escapeHtml(tx.note || "")}\n${escapeHtml(when)}</div>
                </div>
                <div class="amt ${cls}">${sign}${Math.abs(amt).toFixed(2)} GBP</div>
              </div>
            `;
          }).join("");
          return;
        }

        txBody.innerHTML = `<div class="empty">No transactions yet.</div>`;
      } catch(err){
        console.error(err);
        txBody.innerHTML = `<div class="empty">Couldn't load transactions.</div>`;
      }
    }

    function wireTiles(isPaid, isAdmin){
      // Show admin section ONLY for admins
      if (isAdmin){
        adminSection.style.display = "block";
      }

      document.querySelectorAll(".tile").forEach(tile => {
        const href = tile.getAttribute("data-href");
        const needsPaid = tile.getAttribute("data-paid") === "true";
        const needsAdmin = tile.getAttribute("data-admin") === "true";

        // Admin tiles only work if user is admin
        if (needsAdmin && !isAdmin){
          return;
        }

        // Add or remove lock class based on paid status
        if (needsPaid && !isPaid && !isAdmin){
          tile.classList.add("locked");
        } else {
          tile.classList.remove("locked");
        }

        tile.addEventListener("click", () => {
          // If needs paid and user isn't paid/admin, show locked modal
          if (needsPaid && !isPaid && !isAdmin){
            openLockedModal();
            return;
          }
          if (href) location.href = href;
        });
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user){
        location.href = "login.html";
        return;
      }

      const isAdmin = ADMIN_UIDS.has(user.uid);

      let isPaid = false;
      try{
        const uref = doc(db, "Users", user.uid);
        const usnap = await getDoc(uref);
        if (usnap.exists()){
          const u = usnap.data();
          const name = u.Username || u.username || u.displayName || "";
          welcomeTitle.textContent = name ? `Welcome back, ${name} üëã` : "Welcome back üëã";
          isPaid = (u.isPaid === true) || (u.subscriptionStatus === "active");
        }
      }catch(e){
        console.warn("Users read failed:", e);
      }

      wireTiles(isPaid, isAdmin);

      // Balance listener
      const aref = doc(db, "Affiliates", user.uid);
      let last = null;

      onSnapshot(aref, (snap) => {
        if (!snap.exists()){
          accountBalanceEl.textContent = moneyGBP(0);
          last = 0;
          return;
        }
        const d = snap.data();
        const current = Number(d.availableBalance ?? d.balance ?? 0);

        if (last === null){
          accountBalanceEl.textContent = moneyGBP(current);
          last = current;
          return;
        }

        if (current > last){
          animateNumber(last, current, 850);
          pulse();
        } else {
          animateNumber(last, current, 550);
        }

        last = current;
      });
    });
  </script>
</body>
</html>