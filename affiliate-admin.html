<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Affiliate Admin Panel | The Arcane Archives</title>
  <link rel="icon" href="ArcaneA.png" />
  <link rel="apple-touch-icon" href="ArcaneA.png">
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-0: #09090b;
      --bg-1: #0f0f12;
      --bg-2: #16161a;
      --bg-3: #1e1e24;
      --bg-glass: rgba(22, 22, 26, 0.7);
      --accent: #8b5cf6;
      --accent-dark: #7c3aed;
      --accent-light: #a78bfa;
      --accent-glow: rgba(139, 92, 246, 0.15);
      --accent-glow-strong: rgba(139, 92, 246, 0.35);
      --green: #22c55e;
      --green-glow: rgba(34, 197, 94, 0.15);
      --red: #ef4444;
      --red-glow: rgba(239, 68, 68, 0.15);
      --gold: #fbbf24;
      --gold-glow: rgba(251, 191, 36, 0.15);
      --text-0: #fafafa;
      --text-1: #a1a1aa;
      --text-2: #71717a;
      --border: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(255, 255, 255, 0.15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg-0);
      background-image: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 24px 24px;
      color: var(--text-0);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
    }

    body::after {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at 50% 0%, var(--accent-glow) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding-top: env(safe-area-inset-top);
    }

    .topbar-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1.5rem;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .topbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .topbar-icon {
      font-size: 1.25rem;
      line-height: 1;
    }

    .topbar-title {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--text-0);
      letter-spacing: -0.01em;
    }

    .topbar-badge {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      background: var(--accent-glow);
      color: var(--accent-light);
      border: 1px solid rgba(139, 92, 246, 0.25);
    }

    .topbar-back {
      font-size: 0.85rem;
      color: var(--text-1);
      text-decoration: none;
      transition: color 0.15s;
      font-weight: 500;
    }

    .topbar-back:hover {
      color: var(--accent-light);
    }

    /* ‚îÄ‚îÄ Page Layout ‚îÄ‚îÄ */
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
      position: relative;
      z-index: 1;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.025em;
      color: var(--text-0);
      margin-bottom: 0.35rem;
    }

    .page-header p {
      color: var(--text-2);
      font-size: 0.95rem;
    }

    /* ‚îÄ‚îÄ Toast Messages ‚îÄ‚îÄ */
    .message {
      padding: 0.85rem 1.25rem;
      border-radius: var(--radius-md);
      margin-bottom: 1.25rem;
      display: none;
      font-size: 0.9rem;
      font-weight: 500;
      animation: slideDown 0.3s ease-out;
    }

    .success-message {
      background: var(--green-glow);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: var(--green);
    }

    .error-message {
      background: var(--red-glow);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--red);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.75rem;
      margin-bottom: 1.5rem;
      position: relative;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 24px;
      right: 24px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.06), transparent);
    }

    /* ‚îÄ‚îÄ Stats Grid ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      position: relative;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 16px;
      right: 16px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
    }

    .stat-card.stat-green {
      border-color: rgba(34, 197, 94, 0.2);
      background: linear-gradient(135deg, var(--green-glow), transparent);
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      margin-bottom: 0.6rem;
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.65rem;
      font-weight: 700;
      color: var(--accent-light);
      letter-spacing: -0.02em;
    }

    .stat-value.green {
      color: var(--green);
    }

    /* ‚îÄ‚îÄ Section Titles ‚îÄ‚îÄ */
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-0);
      margin-bottom: 1.25rem;
      letter-spacing: -0.01em;
    }

    .section-subtitle {
      color: var(--text-2);
      font-size: 0.875rem;
      margin-bottom: 1.25rem;
      line-height: 1.5;
    }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .table-wrap {
      overflow-x: auto;
      border-radius: var(--radius-md);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-1);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    th {
      text-align: left;
      padding: 0.85rem 1rem;
      border-bottom: 1px solid var(--border);
      color: var(--text-2);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      white-space: nowrap;
    }

    td {
      padding: 0.85rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.875rem;
      color: var(--text-1);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr {
      transition: background 0.15s;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 0.8rem;
      font-family: 'Inter', sans-serif;
      margin-right: 0.5rem;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background: var(--accent-dark);
      box-shadow: 0 0 20px var(--accent-glow-strong);
    }

    .btn-secondary {
      background: var(--bg-2);
      color: var(--text-1);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--border-hover);
      color: var(--text-0);
    }

    .btn-success {
      background: var(--green);
      color: white;
    }

    .btn-success:hover {
      background: #16a34a;
      box-shadow: 0 0 16px var(--green-glow);
    }

    .btn-danger {
      background: var(--red);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      box-shadow: 0 0 16px var(--red-glow);
    }

    /* ‚îÄ‚îÄ Status Badges ‚îÄ‚îÄ */
    .status-badge {
      display: inline-block;
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .status-active {
      background: var(--green-glow);
      color: var(--green);
    }

    .status-pending {
      background: var(--gold-glow);
      color: var(--gold);
    }

    .status-inactive {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-2);
    }

    /* ‚îÄ‚îÄ Loading / Empty ‚îÄ‚îÄ */
    .loading {
      text-align: center;
      padding: 2.5rem;
      color: var(--text-2);
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-2);
    }

    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
    }

    .empty-state p {
      font-size: 0.9rem;
    }

    /* ‚îÄ‚îÄ Inline Sub-Cards ‚îÄ‚îÄ */
    .summary-card {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .summary-card.accent-border {
      border-color: rgba(139, 92, 246, 0.2);
    }

    .summary-card.gold-border {
      border-color: rgba(251, 191, 36, 0.2);
    }

    .summary-card.green-border {
      border-color: rgba(34, 197, 94, 0.2);
    }

    .summary-card h3 {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 0.85rem;
      letter-spacing: -0.01em;
    }

    .summary-card h4 {
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 0.4rem;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }

    .summary-grid .mini-label {
      color: var(--text-2);
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .summary-grid .mini-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* ‚îÄ‚îÄ Code inline ‚îÄ‚îÄ */
    code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      background: var(--accent-glow);
      padding: 0.2rem 0.45rem;
      border-radius: 4px;
      color: var(--accent-light);
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .card {
        padding: 1.25rem;
      }

      .stat-value {
        font-size: 1.3rem;
      }

      table {
        font-size: 0.8rem;
      }

      th, td {
        padding: 0.65rem 0.5rem;
      }

      .btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.75rem;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      .page-header h1 {
        font-size: 1.35rem;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .topbar-inner {
        padding: 0 1rem;
      }

      .page {
        padding: 1.25rem 1rem 3rem;
      }

      .card {
        padding: 1rem;
        border-radius: var(--radius-md);
      }

      th, td {
        padding: 0.5rem 0.4rem;
        font-size: 0.75rem;
      }
    }

    .status-approved {
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent-light);
    }

    .pay-ref-tag {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      background: rgba(34,197,94,0.1);
      color: var(--green);
      padding: 0.15rem 0.45rem;
      border-radius: 4px;
      display: inline-block;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }

    .filter-active {
      background: var(--accent) !important;
      color: white !important;
      border-color: var(--accent) !important;
    }

    #payRefModal, #markPaidModal {
      display: none;
    }
    #payRefModal.open, #markPaidModal.open {
      display: flex !important;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="topbar-brand">
        <div class="topbar-icon">üèÜ</div>
        <span class="topbar-title">Affiliate Admin</span>
        <span class="topbar-badge">Admin</span>
      </div>
      <a href="dashboard.html" class="topbar-back">&larr; Dashboard</a>
    </div>
  </div>

  <div class="page">
    <div class="page-header">
      <h1>Affiliate Management</h1>
      <p>Manage affiliates, commissions, and payouts</p>
    </div>

    <div id="successMessage" class="message success-message"></div>
    <div id="errorMessage" class="message error-message"></div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Affiliates</div>
        <div class="stat-value" id="totalAffiliates">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Referrals</div>
        <div class="stat-value" id="activeReferrals">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Commissions</div>
        <div class="stat-value" id="totalCommissions">&pound;-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending Withdrawals</div>
        <div class="stat-value" id="pendingWithdrawals">&pound;-</div>
      </div>
      <div class="stat-card stat-green">
        <div class="stat-label">Total Paid Out</div>
        <div class="stat-value green" id="totalPaidOut">&pound;-</div>
      </div>
    </div>

    <!-- Affiliates Table -->
    <div class="card">
      <h2 class="section-title">All Affiliates</h2>
      <div id="loadingAffiliates" class="loading">Loading affiliates...</div>
      <div id="emptyAffiliates" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üìä</div>
        <p>No affiliates yet</p>
      </div>
      <div class="table-wrap">
        <table id="affiliatesTable" style="display: none;">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Code</th>
              <th>Total Refs</th>
              <th>Active</th>
              <th>Total Earned</th>
              <th>Available</th>
              <th>Pending</th>
              <th>Withdrawn</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="affiliatesTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Data Integrity Repair Tool -->
    <div class="card" style="border-color: rgba(251,191,36,0.2);">
      <h2 class="section-title">üîß Data Integrity &amp; Repair</h2>
      <p class="section-subtitle" style="margin-bottom:1rem;">
        Run this if referral counts look wrong. It scans all Users, normalises referral code casing, and rebuilds Affiliates docs from live data ‚Äî fixing any mismatches caused by testing or webhook failures.
      </p>
      <button id="syncRepairBtn" style="padding:0.65rem 1.25rem; border-radius:var(--radius-sm); background:linear-gradient(135deg,#f59e0b,#d97706); color:#000; border:none; font-weight:700; cursor:pointer; font-family:'Inter',sans-serif; font-size:0.85rem;">
        üîß Scan &amp; Repair Referral Data
      </button>
      <div id="syncRepairLog" style="display:none; margin-top:1.25rem; background:var(--bg-3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:1rem; font-family:'JetBrains Mono',monospace; font-size:0.75rem; color:var(--text-1); max-height:300px; overflow-y:auto; white-space:pre-wrap;"></div>
    </div>

    <!-- Monthly Earnings Calculator -->
    <div class="card">
      <h2 class="section-title">Monthly Earnings Calculator</h2>
      <p class="section-subtitle">
        Calculate how much each affiliate earned this month (&pound;25 per active referral)
      </p>

      <div style="margin-bottom: 1.25rem; display: flex; flex-wrap: wrap; gap: 0.75rem;">
        <button id="calculateMonthlyBtn" class="btn-primary" style="padding: 0.65rem 1.25rem; border-radius: var(--radius-sm); background: var(--accent); color: white; border: none; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.85rem;">
          Calculate Current Month Earnings
        </button>
        <button id="exportCSVBtn" class="btn-secondary" style="padding: 0.65rem 1.25rem; border-radius: var(--radius-sm); background: var(--bg-2); color: var(--gold); border: 1px solid rgba(251, 191, 36, 0.25); font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.85rem;">
          Export to CSV
        </button>
      </div>

      <div id="monthlyCalculation" style="display: none;">
        <div class="summary-card accent-border">
          <h3 style="color: var(--accent-light);">Calculation Summary</h3>
          <div class="summary-grid">
            <div>
              <div class="mini-label">Total Users with Referrals</div>
              <div class="mini-value" style="color: var(--accent-light);" id="totalAffiliatesCount">0</div>
            </div>
            <div>
              <div class="mini-label">Total Active Referrals</div>
              <div class="mini-value" style="color: var(--green);" id="totalActiveRefs">0</div>
            </div>
            <div>
              <div class="mini-label">Total Monthly Payout</div>
              <div class="mini-value" style="color: var(--gold);" id="totalMonthlyPayout">&pound;0</div>
            </div>
          </div>
        </div>

        <div class="summary-card gold-border">
          <h4 style="color: var(--gold);">Release Earnings to Affiliates</h4>
          <p style="color: var(--text-2); font-size: 0.825rem; margin-bottom: 0.85rem; line-height: 1.5;">
            Stripe automatically holds each commission in <strong style="color:var(--gold);">Pending</strong> when a referral pays. Click below to release all pending earnings to <strong style="color:var(--green);">Available</strong> so affiliates can withdraw. Run this once a month.
          </p>
          <div id="releaseSummary" style="display:none; background:var(--bg-3); border-radius:var(--radius-sm); padding:0.85rem; margin-bottom:0.85rem; font-size:0.82rem; color:var(--text-1);"></div>
          <button id="releaseAllBtn" class="btn-primary" style="padding: 0.65rem 1.25rem; border-radius: var(--radius-sm); background: linear-gradient(135deg, var(--green), #16a34a); color: white; border: none; font-weight: 700; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.85rem;">
            üöÄ Release All Pending ‚Üí Available
          </button>
        </div>

        <div class="table-wrap">
          <table id="monthlyEarningsTable">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Code</th>
                <th>Total Refs</th>
                <th>Active (Paid)</th>
                <th>Monthly Earnings</th>
                <th>Balance</th>
                <th>Payment Method</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="monthlyEarningsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Payout Queue ‚Äî pending items needing action -->
    <div class="card" id="payoutQueueCard" style="display:none;">
      <h2 class="section-title">‚ö° Payout Queue</h2>
      <p class="section-subtitle" style="margin-bottom:1rem;">Approved withdrawals waiting for you to physically send money. Mark as Paid once sent.</p>
      <div class="table-wrap">
        <table id="payoutQueueTable">
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Method</th>
              <th style="min-width:260px;">Send To</th>
              <th>Approved</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="payoutQueueBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Withdrawal Requests -->
    <div class="card">
      <h2 class="section-title">Withdrawal Requests</h2>
      <div style="margin-bottom:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button id="filterAll" class="btn btn-primary" onclick="filterWithdrawals('all')" style="font-size:0.78rem;">All</button>
        <button id="filterPending" class="btn btn-secondary" onclick="filterWithdrawals('pending')" style="font-size:0.78rem;">‚è≥ Pending</button>
        <button id="filterApproved" class="btn btn-secondary" onclick="filterWithdrawals('approved')" style="font-size:0.78rem;">‚úÖ Approved</button>
        <button id="filterCompleted" class="btn btn-secondary" onclick="filterWithdrawals('completed')" style="font-size:0.78rem;">üíö Completed</button>
        <button id="filterRejected" class="btn btn-secondary" onclick="filterWithdrawals('rejected')" style="font-size:0.78rem;">‚ùå Rejected</button>
      </div>
      <div id="loadingWithdrawals" class="loading">Loading withdrawal requests...</div>
      <div id="emptyWithdrawals" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üí∏</div>
        <p>No withdrawal requests</p>
      </div>
      <div class="table-wrap">
        <table id="withdrawalsTable" style="display: none;">
          <thead>
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Amount</th>
              <th>Method</th>
              <th style="min-width: 260px;">Payment Details</th>
              <th>Status</th>
              <th>Ref / Note</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Pay Reference Modal -->
    <div id="payRefModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:999; align-items:center; justify-content:center;">
      <div style="background:var(--bg-2); border:1px solid var(--border); border-radius:var(--radius-lg); padding:2rem; max-width:480px; width:90%; position:relative;">
        <h3 style="margin-bottom:0.5rem;">‚úÖ Approve Withdrawal</h3>
        <p id="payRefModalDesc" style="color:var(--text-2); font-size:0.85rem; margin-bottom:1.25rem; line-height:1.5;"></p>
        <label style="display:block; font-size:0.8rem; color:var(--text-2); margin-bottom:0.4rem;">Payment Reference / Note (optional)</label>
        <input id="payRefInput" type="text" placeholder="e.g. Bank ref: 123456 / TX hash: 0xabc..." style="width:100%; background:var(--bg-3); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-0); padding:0.65rem 0.85rem; font-size:0.875rem; margin-bottom:1.25rem; font-family:'Inter',sans-serif;" />
        <div style="display:flex; gap:0.75rem;">
          <button id="payRefConfirmBtn" class="btn btn-success" style="flex:1;">‚úÖ Approve & Record</button>
          <button onclick="closePayRefModal()" class="btn btn-secondary" style="flex:1;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Mark Paid Modal -->
    <div id="markPaidModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:999; align-items:center; justify-content:center;">
      <div style="background:var(--bg-2); border:1px solid var(--border); border-radius:var(--radius-lg); padding:2rem; max-width:480px; width:90%; position:relative;">
        <h3 style="margin-bottom:0.5rem;">üíö Mark as Paid</h3>
        <p id="markPaidModalDesc" style="color:var(--text-2); font-size:0.85rem; margin-bottom:1.25rem; line-height:1.5;"></p>
        <label style="display:block; font-size:0.8rem; color:var(--text-2); margin-bottom:0.4rem;">Payment Reference (required ‚Äî bank ref or TX hash)</label>
        <input id="markPaidRefInput" type="text" placeholder="e.g. BACS ref: AA123456 / TX: 0xabc123..." style="width:100%; background:var(--bg-3); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-0); padding:0.65rem 0.85rem; font-size:0.875rem; margin-bottom:1.25rem; font-family:'Inter',sans-serif;" />
        <div style="display:flex; gap:0.75rem;">
          <button id="markPaidConfirmBtn" class="btn btn-success" style="flex:1;">üíö Confirm Payment Sent</button>
          <button onclick="closeMarkPaidModal()" class="btn btn-secondary" style="flex:1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      query,
      where,
      orderBy,
      increment,
      addDoc,
      serverTimestamp,
      writeBatch,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
      authDomain: "arcane-archives-3b0f5.firebaseapp.com",
      projectId: "arcane-archives-3b0f5",
      storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
      messagingSenderId: "264237235055",
      appId: "1:264237235055:web:4a2e5605b0ffb5307f069a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 3000);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    // Check admin access
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      const ADMIN_EMAILS = ['leogray15@gmail.com', 'lorenzo.versari@icloud.com'];
      const ADMIN_UIDS = ['U4PvQ0dilBco97hgXp3Awl45JX92', 'liMx3vjGGrgAta12IlKclq3Xwvr2'];

      if (!ADMIN_EMAILS.includes(user.email) && !ADMIN_UIDS.includes(user.uid)) {
        showError('Access denied. Admin only.');
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 2000);
        return;
      }

      currentUser = user;

      // Load data
      await loadStats();
      await loadAffiliates();
      await loadWithdrawals();
    });

    async function loadStats() {
      try {
        const [affiliatesSnap, withdrawalsSnap] = await Promise.all([
          getDocs(collection(db, 'Affiliates')),
          getDocs(collection(db, 'WithdrawalRequests'))
        ]);

        let totalAffiliatesCount = 0;
        let activeReferralsCount = 0;
        let totalCommissionsAmount = 0;
        let totalAvailableBalance = 0;
        let pendingWithdrawalsAmount = 0;
        let approvedWithdrawalsAmount = 0;
        let totalPaidOutAmount = 0;

        affiliatesSnap.forEach(d => {
          const data = d.data();
          totalAffiliatesCount++;
          activeReferralsCount += data.activeReferrals || 0;
          totalCommissionsAmount += data.totalEarned || 0;
          totalAvailableBalance += data.availableBalance || 0;
        });

        withdrawalsSnap.forEach(d => {
          const data = d.data();
          if (data.status === 'pending') pendingWithdrawalsAmount += data.amount || 0;
          if (data.status === 'approved') approvedWithdrawalsAmount += data.amount || 0;
          if (data.status === 'completed') totalPaidOutAmount += data.amount || 0;
        });

        document.getElementById('totalAffiliates').textContent = totalAffiliatesCount;
        document.getElementById('activeReferrals').textContent = activeReferralsCount;
        document.getElementById('totalCommissions').textContent = `¬£${totalCommissionsAmount.toFixed(2)}`;
        document.getElementById('pendingWithdrawals').textContent = `¬£${(pendingWithdrawalsAmount + approvedWithdrawalsAmount).toFixed(2)}`;
        document.getElementById('totalPaidOut').textContent = `¬£${totalPaidOutAmount.toFixed(2)}`;

      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    async function loadAffiliates() {
      const loadingEl = document.getElementById('loadingAffiliates');
      const emptyEl = document.getElementById('emptyAffiliates');
      const tableEl = document.getElementById('affiliatesTable');
      const tbody = document.getElementById('affiliatesTableBody');

      try {
        // Pull real balances from Affiliates collection
        const [affiliatesSnap, usersSnap] = await Promise.all([
          getDocs(collection(db, 'Affiliates')),
          getDocs(collection(db, 'Users'))
        ]);

        // Build a user lookup map
        const usersMap = {};
        usersSnap.forEach(d => { usersMap[d.id] = d.data(); });

        loadingEl.style.display = 'none';

        if (affiliatesSnap.empty) {
          emptyEl.style.display = 'block';
          return;
        }

        const affiliates = [];
        affiliatesSnap.forEach(d => {
          const aff = d.data();
          const user = usersMap[d.id] || {};
          affiliates.push({
            userId: d.id,
            username: user.Username || aff.username || 'Unknown',
            email: user.Email || aff.email || '-',
            referralCode: aff.referralCode || user.referralCode || '-',
            totalReferrals: aff.totalReferrals || 0,
            activeReferrals: aff.activeReferrals || 0,
            totalEarned: aff.totalEarned || 0,
            availableBalance: aff.availableBalance || 0,
            pendingBalance: aff.pendingBalance || 0,
            totalWithdrawn: aff.totalWithdrawn || 0
          });
        });

        // Sort by totalEarned desc
        affiliates.sort((a,b) => b.totalEarned - a.totalEarned);

        tableEl.style.display = 'table';
        tbody.innerHTML = '';

        affiliates.forEach(affiliate => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong style="color:var(--text-0);">${escapeHtml(affiliate.username)}</strong></td>
            <td style="color:var(--text-2); font-size:0.8rem;">${escapeHtml(affiliate.email)}</td>
            <td><code>${affiliate.referralCode}</code></td>
            <td style="text-align:center;">${affiliate.totalReferrals}</td>
            <td style="text-align:center;"><strong style="color:var(--green);">${affiliate.activeReferrals}</strong></td>
            <td><strong style="color:var(--green);">¬£${affiliate.totalEarned.toFixed(2)}</strong></td>
            <td><strong style="color:var(--gold);">¬£${affiliate.availableBalance.toFixed(2)}</strong></td>
            <td style="color:var(--text-2);">¬£${affiliate.pendingBalance.toFixed(2)}</td>
            <td style="color:var(--text-2);">¬£${affiliate.totalWithdrawn.toFixed(2)}</td>
            <td>
              <span class="status-badge ${affiliate.activeReferrals > 0 ? 'status-active' : 'status-inactive'}">
                ${affiliate.activeReferrals > 0 ? 'Active' : 'Inactive'}
              </span>
            </td>
          `;
          tbody.appendChild(row);
        });

      } catch (error) {
        console.error('Error loading affiliates:', error);
        loadingEl.innerHTML = `<p style="color: var(--red);">Error loading affiliates: ${error.message}</p>`;
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let allWithdrawals = [];
    let currentFilter = 'all';

    window.filterWithdrawals = function(filter) {
      currentFilter = filter;
      ['filterAll','filterPending','filterApproved','filterCompleted','filterRejected'].forEach(id => {
        document.getElementById(id)?.classList.remove('filter-active');
      });
      const btnMap = { all:'filterAll', pending:'filterPending', approved:'filterApproved', completed:'filterCompleted', rejected:'filterRejected' };
      document.getElementById(btnMap[filter])?.classList.add('filter-active');
      renderWithdrawals(filter === 'all' ? allWithdrawals : allWithdrawals.filter(w => w.status === filter));
    };

    function formatPaymentDetails(w) {
      if (w.method === 'bank') {
        const name = w.accountName || w.bankDetails?.accountName || '-';
        const sort = w.sortCode || w.bankDetails?.sortCode || '-';
        const acct = w.accountNumber || w.bankDetails?.accountNumber || '-';
        const bank = w.bankName || w.bankDetails?.bankName || '';
        return `<div style="font-size:0.78rem;line-height:1.6;">
          <strong style="color:var(--text-0);">üè¶ Bank Transfer</strong><br/>
          <span style="color:var(--text-2);">Name:</span> <strong>${escapeHtml(name)}</strong><br/>
          ${bank ? `<span style="color:var(--text-2);">Bank:</span> ${escapeHtml(bank)}<br/>` : ''}
          <span style="color:var(--text-2);">Sort:</span> <code style="font-size:0.72rem;">${escapeHtml(sort)}</code>&nbsp;&nbsp;
          <span style="color:var(--text-2);">Acc:</span> <code style="font-size:0.72rem;">${escapeHtml(acct)}</code>
        </div>`;
      } else if (w.method === 'crypto') {
        const type = w.cryptoType || 'CRYPTO';
        const net = w.network || '';
        const addr = w.walletAddress || w.cryptoWallet || '-';
        return `<div style="font-size:0.78rem;line-height:1.6;">
          <strong style="color:var(--text-0);">‚Çø ${escapeHtml(type)}</strong> ${net ? `<span style="color:var(--text-2);font-size:0.72rem;">${escapeHtml(net)}</span>` : ''}<br/>
          <code style="font-size:0.68rem;word-break:break-all;color:var(--accent-light);">${escapeHtml(addr)}</code>
        </div>`;
      }
      return w.details ? escapeHtml(w.details) : '-';
    }

    function renderWithdrawals(withdrawals) {
      const emptyEl = document.getElementById('emptyWithdrawals');
      const tableEl = document.getElementById('withdrawalsTable');
      const tbody = document.getElementById('withdrawalsTableBody');

      if (withdrawals.length === 0) {
        emptyEl.style.display = 'block';
        tableEl.style.display = 'none';
        return;
      }
      emptyEl.style.display = 'none';
      tableEl.style.display = 'table';
      tbody.innerHTML = '';

      withdrawals.forEach(w => {
        const date = w.createdAt?.toDate ? w.createdAt.toDate().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'}) : '-';
        const statusClass = {pending:'status-pending', approved:'status-approved', completed:'status-active', rejected:'status-inactive'}[w.status] || 'status-inactive';
        const statusLabel = {pending:'‚è≥ Pending', approved:'‚úÖ Approved', completed:'üíö Paid', rejected:'‚ùå Rejected'}[w.status] || w.status;
        const payRef = w.paymentRef ? `<span class="pay-ref-tag" title="${escapeHtml(w.paymentRef)}">${escapeHtml(w.paymentRef)}</span>` : (w.adminNote ? `<span style="font-size:0.75rem;color:var(--text-2);">${escapeHtml(w.adminNote)}</span>` : '<span style="color:var(--text-2);font-size:0.78rem;">‚Äî</span>');

        let actions = '<span style="color:var(--text-2);font-size:0.78rem;">‚Äî</span>';
        if (w.status === 'pending') {
          actions = `
            <button class="btn btn-success" style="margin-bottom:0.35rem;" onclick="openPayRefModal('${w.id}','${w.userId}',${w.amount})">‚úÖ Approve</button>
            <button class="btn btn-danger" onclick="window.rejectWithdrawal('${w.id}')">‚ùå Reject</button>
          `;
        } else if (w.status === 'approved') {
          actions = `<button class="btn btn-primary" onclick="openMarkPaidModal('${w.id}')">üíö Mark Paid</button>`;
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="font-size:0.78rem;color:var(--text-2);white-space:nowrap;">${date}</td>
          <td><strong style="color:var(--text-0);">${escapeHtml(w._username || 'Unknown')}</strong><br/><small style="color:var(--text-2);">${escapeHtml(w._email || '')}</small></td>
          <td><strong style="color:var(--gold);font-size:1rem;">¬£${w.amount.toFixed(2)}</strong></td>
          <td>${w.method === 'bank' ? 'üè¶ Bank' : w.method === 'crypto' ? '‚Çø Crypto' : '-'}</td>
          <td style="max-width:280px;">${formatPaymentDetails(w)}</td>
          <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
          <td>${payRef}</td>
          <td style="white-space:nowrap;">${actions}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function loadWithdrawals() {
      const loadingEl = document.getElementById('loadingWithdrawals');

      try {
        const [withdrawalsSnap, usersSnap] = await Promise.all([
          getDocs(query(collection(db, 'WithdrawalRequests'), orderBy('createdAt', 'desc'))),
          getDocs(collection(db, 'Users'))
        ]);

        const usersMap = {};
        usersSnap.forEach(d => { usersMap[d.id] = d.data(); });

        loadingEl.style.display = 'none';

        allWithdrawals = [];
        withdrawalsSnap.forEach(d => {
          const w = { id: d.id, ...d.data() };
          const user = usersMap[w.userId] || {};
          w._username = user.Username || 'Unknown';
          w._email = user.Email || '';
          allWithdrawals.push(w);
        });

        // Build payout queue ‚Äî approved items not yet marked paid
        buildPayoutQueue(allWithdrawals);

        filterWithdrawals(currentFilter);

      } catch (error) {
        console.error('Error loading withdrawals:', error);
        loadingEl.innerHTML = `<p style="color: var(--red);">Error: ${error.message}</p>`;
      }
    }

    function buildPayoutQueue(withdrawals) {
      const queueCard = document.getElementById('payoutQueueCard');
      const queueBody = document.getElementById('payoutQueueBody');
      const approved = withdrawals.filter(w => w.status === 'approved');

      if (approved.length === 0) {
        queueCard.style.display = 'none';
        return;
      }
      queueCard.style.display = 'block';
      queueBody.innerHTML = '';

      approved.forEach(w => {
        const approvedDate = w.approvedAt?.toDate ? w.approvedAt.toDate().toLocaleDateString('en-GB', {day:'2-digit',month:'short'}) : '-';
        const row = document.createElement('tr');
        row.style.background = 'rgba(139,92,246,0.04)';
        row.innerHTML = `
          <td><strong style="color:var(--text-0);">${escapeHtml(w._username)}</strong><br/><small style="color:var(--text-2);">${escapeHtml(w._email)}</small></td>
          <td><strong style="color:var(--gold);font-size:1.1rem;">¬£${w.amount.toFixed(2)}</strong></td>
          <td>${w.method === 'bank' ? 'üè¶ Bank' : '‚Çø Crypto'}</td>
          <td style="max-width:260px;">${formatPaymentDetails(w)}</td>
          <td style="font-size:0.78rem;color:var(--text-2);">${approvedDate}</td>
          <td><button class="btn btn-primary" onclick="openMarkPaidModal('${w.id}')">üíö Mark as Paid</button></td>
        `;
        queueBody.appendChild(row);
      });
    }

    // ‚îÄ‚îÄ Pay Ref Modal (Approve step) ‚îÄ‚îÄ
    let _pendingApproval = null;
    window.openPayRefModal = function(withdrawalId, userId, amount) {
      _pendingApproval = { withdrawalId, userId, amount };
      document.getElementById('payRefModalDesc').innerHTML =
        `Approving <strong style="color:var(--gold);">¬£${parseFloat(amount).toFixed(2)}</strong> withdrawal.<br/>
        The balance will be <strong>deducted now</strong>. You'll mark it as physically sent separately.`;
      document.getElementById('payRefInput').value = '';
      document.getElementById('payRefModal').classList.add('open');
    };
    window.closePayRefModal = function() {
      document.getElementById('payRefModal').classList.remove('open');
      _pendingApproval = null;
    };
    document.getElementById('payRefConfirmBtn').addEventListener('click', async () => {
      if (!_pendingApproval) return;
      const { withdrawalId, userId, amount } = _pendingApproval;
      const adminNote = document.getElementById('payRefInput').value.trim();
      closePayRefModal();
      await approveWithdrawalAction(withdrawalId, userId, amount, adminNote);
    });

    async function approveWithdrawalAction(withdrawalId, userId, amount, adminNote) {
      try {
        const affiliateRef = doc(db, 'Affiliates', userId);
        const affiliateSnap = await getDoc(affiliateRef);

        if (!affiliateSnap.exists()) {
          showError('‚ùå Affiliate account not found. The Affiliates collection may need to be re-created (next payment will auto-create it).');
          return;
        }

        const currentBalance = affiliateSnap.data().availableBalance || 0;
        if (currentBalance < amount) {
          showError(`‚ùå Insufficient balance! User has ¬£${currentBalance.toFixed(2)}, requesting ¬£${parseFloat(amount).toFixed(2)}`);
          return;
        }

        await runTransaction(db, async (transaction) => {
          const freshDoc = await transaction.get(affiliateRef);
          const freshBalance = freshDoc.data().availableBalance || 0;
          if (freshBalance < amount) throw new Error(`Balance dropped to ¬£${freshBalance}`);

          const withdrawalRef = doc(db, 'WithdrawalRequests', withdrawalId);
          const txRef = doc(collection(db, 'BalanceTransactions'));

          transaction.update(affiliateRef, {
            availableBalance: freshBalance - amount,
            totalWithdrawn: (freshDoc.data().totalWithdrawn || 0) + amount,
            lastWithdrawal: serverTimestamp()
          });

          transaction.update(withdrawalRef, {
            status: 'approved',
            approvedAt: serverTimestamp(),
            processedBy: currentUser.uid,
            adminNote: adminNote || null
          });

          transaction.set(txRef, {
            userId,
            type: 'withdrawal_approved',
            amount: -amount,
            description: `Withdrawal approved ‚Äî ¬£${parseFloat(amount).toFixed(2)}`,
            balanceBefore: freshBalance,
            balanceAfter: freshBalance - amount,
            adminNote: adminNote || null,
            createdAt: serverTimestamp(),
            processedBy: currentUser.uid
          });
        });

        showSuccess(`‚úÖ Approved! ¬£${parseFloat(amount).toFixed(2)} deducted from balance. Now physically send the money and mark as Paid.`);
        await loadWithdrawals();
        await loadStats();
        await loadAffiliates();

      } catch (error) {
        console.error('Error approving withdrawal:', error);
        showError('‚ùå Failed to approve: ' + error.message);
      }
    }

    // ‚îÄ‚îÄ Mark Paid Modal (after money is physically sent) ‚îÄ‚îÄ
    let _pendingMarkPaid = null;
    window.openMarkPaidModal = function(withdrawalId) {
      _pendingMarkPaid = { withdrawalId };
      const w = allWithdrawals.find(x => x.id === withdrawalId);
      document.getElementById('markPaidModalDesc').innerHTML =
        w ? `Mark <strong style="color:var(--gold);">¬£${w.amount.toFixed(2)}</strong> to <strong>${escapeHtml(w._username)}</strong> as physically sent.<br/>Enter your payment reference so there's a full audit trail.` : 'Confirm payment was sent.';
      document.getElementById('markPaidRefInput').value = '';
      document.getElementById('markPaidModal').classList.add('open');
    };
    window.closeMarkPaidModal = function() {
      document.getElementById('markPaidModal').classList.remove('open');
      _pendingMarkPaid = null;
    };
    document.getElementById('markPaidConfirmBtn').addEventListener('click', async () => {
      if (!_pendingMarkPaid) return;
      const ref = document.getElementById('markPaidRefInput').value.trim();
      if (!ref) {
        document.getElementById('markPaidRefInput').style.border = '1px solid var(--red)';
        document.getElementById('markPaidRefInput').placeholder = '‚ö†Ô∏è Payment reference is required!';
        return;
      }
      const { withdrawalId } = _pendingMarkPaid;
      closeMarkPaidModal();
      await markWithdrawalPaid(withdrawalId, ref);
    });

    async function markWithdrawalPaid(withdrawalId, paymentRef) {
      try {
        const withdrawalRef = doc(db, 'WithdrawalRequests', withdrawalId);
        await updateDoc(withdrawalRef, {
          status: 'completed',
          completedAt: serverTimestamp(),
          paymentRef: paymentRef,
          markedPaidBy: currentUser.uid
        });

        // Also log the completion in BalanceTransactions
        const w = allWithdrawals.find(x => x.id === withdrawalId);
        if (w) {
          await addDoc(collection(db, 'BalanceTransactions'), {
            userId: w.userId,
            type: 'withdrawal_completed',
            amount: -w.amount,
            description: `Payment sent ‚Äî ref: ${paymentRef}`,
            paymentRef: paymentRef,
            createdAt: serverTimestamp(),
            processedBy: currentUser.uid
          });
        }

        showSuccess(`üíö Marked as Paid! Ref: ${paymentRef}`);
        await loadWithdrawals();
        await loadStats();

      } catch (error) {
        console.error('Error marking paid:', error);
        showError('‚ùå Failed: ' + error.message);
      }
    }

    window.rejectWithdrawal = async (withdrawalId) => {
      if (!confirm('Reject this withdrawal request? The user will be notified to resubmit.')) return;

      try {
        await updateDoc(doc(db, 'WithdrawalRequests', withdrawalId), {
          status: 'rejected',
          rejectedAt: serverTimestamp(),
          rejectedBy: currentUser.uid
        });

        showSuccess('Withdrawal rejected.');
        await loadWithdrawals();
        await loadStats();

      } catch (error) {
        console.error('Error rejecting withdrawal:', error);
        showError('Failed to reject: ' + error.message);
      }
    };

    // Monthly Earnings Calculator
    document.getElementById('calculateMonthlyBtn').addEventListener('click', async () => {
      const btn = document.getElementById('calculateMonthlyBtn');
      btn.disabled = true;
      btn.textContent = 'üîÑ Calculating...';

      try {
        // Get all users
        const usersSnapshot = await getDocs(collection(db, 'Users'));

        const affiliateEarnings = [];
        let totalActiveRefs = 0;
        let totalPayout = 0;

        // Build a map of ALL users keyed by uid for fast lookups
        const allUsersMap = {};
        usersSnapshot.forEach(d => { allUsersMap[d.id] = { id: d.id, ...d.data() }; });

        // Build a referral lookup: normalise referredBy to UPPERCASE so case mismatches don't matter
        // referralsByCode[CODE] = array of user data objects referred by that code
        const referralsByCode = {};
        usersSnapshot.forEach(d => {
          const data = d.data();
          if (data.referredBy) {
            const code = data.referredBy.toUpperCase().trim();
            if (!referralsByCode[code]) referralsByCode[code] = [];
            referralsByCode[code].push(data);
          }
        });

        // For each user who has a referralCode, count their active referrals
        const seenCodes = new Set(); // prevent duplicate processing
        for (const userDoc of usersSnapshot.docs) {
          const userData = userDoc.data();
          const referralCode = (userData.referralCode || '').toUpperCase().trim();

          if (!referralCode || seenCodes.has(referralCode)) continue;
          seenCodes.add(referralCode);

          // Get all users referred by this code (case-insensitive via our map)
          const referredUsers = referralsByCode[referralCode] || [];

          // Count active (paid) referrals ‚Äî check ALL possible paid states
          let activeCount = 0;
          let totalCount = referredUsers.length;
          referredUsers.forEach((refData) => {
            if (
              refData.isPaid === true ||
              refData.subscriptionStatus === 'active' ||
              refData.subscriptionStatus === 'Active'
            ) {
              activeCount++;
            }
          });

          // Only include if they have referrals at all
          if (totalCount > 0) {
            const monthlyEarnings = activeCount * 25;
            totalActiveRefs += activeCount;
            totalPayout += monthlyEarnings;

            // Get latest withdrawal method from WithdrawalRequests
            const affiliateDoc = await getDoc(doc(db, 'Affiliates', userDoc.id));
            const affiliateData = affiliateDoc.exists() ? affiliateDoc.data() : {};

            affiliateEarnings.push({
              userId: userDoc.id,
              username: userData.Username || userData.Email?.split('@')[0] || 'Unknown',
              email: userData.Email || 'No email',
              referralCode: referralCode,
              totalReferrals: totalCount,
              activeReferrals: activeCount,
              monthlyEarnings: monthlyEarnings,
              availableBalance: affiliateData.availableBalance || 0,
              paymentMethod: userData.paymentPreferences?.method || 'Not set',
              bankDetails: userData.paymentPreferences?.bankDetails || null,
              cryptoWallet: userData.paymentPreferences?.cryptoWallet || null
            });

            // ‚îÄ‚îÄ Auto-sync the Affiliates doc with the live active count ‚îÄ‚îÄ
            // This keeps Affiliates.activeReferrals accurate even if webhook missed events
            if (affiliateDoc.exists()) {
              const storedActive = affiliateData.activeReferrals || 0;
              if (storedActive !== activeCount) {
                try {
                  await updateDoc(doc(db, 'Affiliates', userDoc.id), {
                    activeReferrals: activeCount,
                    totalReferrals: totalCount,
                    lastSynced: serverTimestamp()
                  });
                  console.log(`‚úÖ Synced ${userData.Username}: activeReferrals ${storedActive} ‚Üí ${activeCount}`);
                } catch (e) {
                  console.warn('Could not sync affiliate doc:', e.message);
                }
              }
            }
          }
        }

        // Update summary stats
        document.getElementById('totalAffiliatesCount').textContent = affiliateEarnings.length;
        document.getElementById('totalActiveRefs').textContent = totalActiveRefs;
        document.getElementById('totalMonthlyPayout').textContent = `¬£${totalPayout}`;

        // Display table
        displayMonthlyEarnings(affiliateEarnings);
        document.getElementById('monthlyCalculation').style.display = 'block';

        btn.textContent = '‚úÖ Calculated!';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'üîÑ Calculate Current Month Earnings';
        }, 2000);

      } catch (error) {
        console.error('Error calculating earnings:', error);
        showError('Failed to calculate earnings: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'üîÑ Calculate Current Month Earnings';
      }
    });

    function displayMonthlyEarnings(earnings) {
      const tbody = document.getElementById('monthlyEarningsBody');
      tbody.innerHTML = '';

      // Sort by monthly earnings (highest first)
      earnings.sort((a, b) => b.monthlyEarnings - a.monthlyEarnings);

      earnings.forEach((affiliate) => {
        const row = document.createElement('tr');

        // Determine if already paid this month (check if they have available balance)
        const alreadyPaid = affiliate.monthlyEarnings === 0 ? '‚úÖ' : '‚è≥ Pending';

        row.innerHTML = `
          <td><strong>${escapeHtml(affiliate.username)}</strong></td>
          <td style="font-size:0.8rem;color:var(--text-2);">${escapeHtml(affiliate.email)}</td>
          <td><code style="background: var(--accent-glow); padding: 0.2rem 0.45rem; border-radius: 4px;">${affiliate.referralCode}</code></td>
          <td style="text-align: center;">${affiliate.totalReferrals || affiliate.activeReferrals}</td>
          <td style="text-align: center;"><strong style="color:var(--green);">${affiliate.activeReferrals}</strong></td>
          <td><strong style="color: var(--gold);">¬£${affiliate.monthlyEarnings}</strong></td>
          <td style="font-size:0.8rem;color:var(--text-2);">¬£${(affiliate.availableBalance || 0).toFixed(2)}</td>
          <td>
            ${affiliate.paymentMethod === 'bank' ? 'üè¶ Bank' :
              affiliate.paymentMethod === 'crypto' ? '‚Çø Crypto' :
              '<span style="color:var(--gold);">‚ö†Ô∏è Not Set</span>'}
          </td>
          <td>${alreadyPaid}</td>
        `;
        tbody.appendChild(row);
      });

      // Store for CSV export
      window.currentEarningsData = earnings;
    }

    // Export to CSV
    document.getElementById('exportCSVBtn').addEventListener('click', () => {
      if (!window.currentEarningsData || window.currentEarningsData.length === 0) {
        showError('‚ö†Ô∏è Please calculate monthly earnings first!');
        return;
      }

      const now = new Date();
      const month = now.toLocaleString('default', { month: 'long' });
      const year = now.getFullYear();

      let csv = `Arcane Archives - Monthly Affiliate Payouts - ${month} ${year}\n\n`;
      csv += 'Username,Email,Referral Code,Active Referrals,Monthly Earnings,Payment Method,Bank Details,Crypto Wallet\n';

      window.currentEarningsData.forEach((affiliate) => {
        const bankDetails = affiliate.bankDetails ?
          `"${affiliate.bankDetails.accountName || ''} | ${affiliate.bankDetails.sortCode || ''} | ${affiliate.bankDetails.accountNumber || ''}"` :
          'Not provided';

        const cryptoWallet = affiliate.cryptoWallet || 'Not provided';

        csv += `"${affiliate.username}","${affiliate.email}","${affiliate.referralCode}",${affiliate.activeReferrals},¬£${affiliate.monthlyEarnings},${affiliate.paymentMethod},${bankDetails},${cryptoWallet}\n`;
      });

      // Calculate total
      const total = window.currentEarningsData.reduce((sum, a) => sum + a.monthlyEarnings, 0);
      csv += `\n,,,TOTAL,¬£${total}`;

      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `arcane-affiliates-${month}-${year}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);

      showSuccess('‚úÖ CSV exported successfully!');
    });

    // ‚îÄ‚îÄ Release All Pending ‚Üí Available ‚îÄ‚îÄ
    // Stripe auto-holds commissions in pendingBalance when payments come in.
    // Admin runs this once a month to release everything to availableBalance
    // so affiliates can withdraw.
    document.getElementById('releaseAllBtn').addEventListener('click', async () => {
      const btn = document.getElementById('releaseAllBtn');

      try {
        // Fetch all affiliates with a pending balance > 0
        const affiliatesSnap = await getDocs(collection(db, 'Affiliates'));
        const usersSnap = await getDocs(collection(db, 'Users'));
        const usersMap = {};
        usersSnap.forEach(d => { usersMap[d.id] = d.data(); });

        const toRelease = [];
        affiliatesSnap.forEach(d => {
          const data = d.data();
          const pending = data.pendingBalance || 0;
          if (pending > 0) {
            toRelease.push({ id: d.id, data, pending });
          }
        });

        if (toRelease.length === 0) {
          showError('‚ÑπÔ∏è No pending balances to release. All affiliates are up to date!');
          return;
        }

        const totalRelease = toRelease.reduce((s, x) => s + x.pending, 0);
        const names = toRelease.map(x => {
          const u = usersMap[x.id] || {};
          return `${u.Username || 'Unknown'}: ¬£${x.pending.toFixed(2)}`;
        }).join('\n');

        const confirmed = window.confirm(
          `Release pending earnings to ${toRelease.length} affiliate${toRelease.length > 1 ? 's' : ''}?\n\n` +
          `${names}\n\n` +
          `Total: ¬£${totalRelease.toFixed(2)}\n\n` +
          `Pending ‚Üí Available. They can then request withdrawal.`
        );

        if (!confirmed) return;

        btn.disabled = true;
        btn.textContent = '‚è≥ Releasing...';

        const currentMonth = new Date().toISOString().slice(0, 7);
        const batch = writeBatch(db);

        for (const item of toRelease) {
          const affRef = doc(db, 'Affiliates', item.id);
          const currentData = item.data;
          const newAvailable = (currentData.availableBalance || 0) + item.pending;

          batch.update(affRef, {
            availableBalance: newAvailable,
            pendingBalance: 0,
            lastReleased: serverTimestamp(),
            lastReleasedMonth: currentMonth
          });

          // Audit trail
          const txRef = doc(collection(db, 'BalanceTransactions'));
          batch.set(txRef, {
            userId: item.id,
            type: 'monthly_release',
            amount: item.pending,
            description: `Monthly release for ${currentMonth} ‚Äî ¬£${item.pending.toFixed(2)} moved to available`,
            balanceBefore: currentData.availableBalance || 0,
            balanceAfter: newAvailable,
            createdAt: serverTimestamp(),
            processedBy: currentUser.uid
          });
        }

        await batch.commit();

        // Show summary
        const summaryEl = document.getElementById('releaseSummary');
        summaryEl.innerHTML = `
          <strong style="color:var(--green);">‚úÖ Released ${toRelease.length} affiliate${toRelease.length > 1 ? 's' : ''} ‚Äî ¬£${totalRelease.toFixed(2)} moved to Available</strong><br/>
          <span style="color:var(--text-2);font-size:0.78rem;">${new Date().toLocaleString('en-GB')} ¬∑ ${currentMonth}</span>
        `;
        summaryEl.style.display = 'block';

        showSuccess(`üöÄ Done! ¬£${totalRelease.toFixed(2)} released to ${toRelease.length} affiliate${toRelease.length > 1 ? 's' : ''}. They can now withdraw.`);

        btn.textContent = '‚úÖ Released!';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'üöÄ Release All Pending ‚Üí Available';
        }, 3000);

        await loadStats();
        await loadAffiliates();

      } catch (error) {
        console.error('Error releasing earnings:', error);
        showError('‚ùå Failed to release: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'üöÄ Release All Pending ‚Üí Available';
      }
    });

    // ‚îÄ‚îÄ Sync & Repair Tool ‚îÄ‚îÄ
    document.getElementById('syncRepairBtn').addEventListener('click', async () => {
      const btn = document.getElementById('syncRepairBtn');
      const log = document.getElementById('syncRepairLog');
      btn.disabled = true;
      btn.textContent = '‚è≥ Scanning...';
      log.style.display = 'block';
      log.textContent = 'üîç Starting scan...\n';

      const logLine = (msg) => { log.textContent += msg + '\n'; log.scrollTop = log.scrollHeight; };

      try {
        const usersSnap = await getDocs(collection(db, 'Users'));
        logLine(`üìä Found ${usersSnap.size} users in database`);

        // Step 1: Fix referredBy casing on all users (normalise to UPPERCASE)
        let fixedCasing = 0;
        const batch1 = writeBatch(db);
        for (const d of usersSnap.docs) {
          const data = d.data();
          if (data.referredBy && data.referredBy !== data.referredBy.toUpperCase()) {
            logLine(`  ‚úèÔ∏è Fixing casing for user ${data.Username || d.id}: "${data.referredBy}" ‚Üí "${data.referredBy.toUpperCase()}"`);
            batch1.update(d.ref, { referredBy: data.referredBy.toUpperCase().trim() });
            fixedCasing++;
          }
          // Also fix referralCode casing
          if (data.referralCode && data.referralCode !== data.referralCode.toUpperCase()) {
            logLine(`  ‚úèÔ∏è Fixing referralCode for ${data.Username || d.id}: "${data.referralCode}" ‚Üí "${data.referralCode.toUpperCase()}"`);
            batch1.update(d.ref, { referralCode: data.referralCode.toUpperCase().trim() });
            fixedCasing++;
          }
        }
        if (fixedCasing > 0) {
          await batch1.commit();
          logLine(`‚úÖ Fixed ${fixedCasing} casing issues`);
        } else {
          logLine('‚úÖ All referral codes already uppercase ‚Äî no casing fixes needed');
        }

        // Step 2: Re-fetch users with corrected data
        const freshSnap = await getDocs(collection(db, 'Users'));

        // Build referralsByCode map (case-normalised)
        const referralsByCode = {};
        const usersByCode = {}; // referralCode ‚Üí owner user doc
        freshSnap.forEach(d => {
          const data = d.data();
          if (data.referralCode) {
            usersByCode[data.referralCode.toUpperCase()] = { id: d.id, ...data };
          }
          if (data.referredBy) {
            const code = data.referredBy.toUpperCase().trim();
            if (!referralsByCode[code]) referralsByCode[code] = [];
            referralsByCode[code].push({ id: d.id, ...data });
          }
        });

        logLine(`\nüì¶ Found ${Object.keys(referralsByCode).length} unique referral codes with referred users`);

        // Step 3: For each affiliate code, rebuild the Affiliates doc
        let rebuilt = 0;
        let skipped = 0;
        const batch2 = writeBatch(db);

        for (const [code, referredUsers] of Object.entries(referralsByCode)) {
          const owner = usersByCode[code];
          if (!owner) {
            logLine(`  ‚ö†Ô∏è Code ${code} ‚Äî no owner found in Users collection (orphan referrals)`);
            skipped++;
            continue;
          }

          const totalReferrals = referredUsers.length;
          const activeReferrals = referredUsers.filter(u =>
            u.isPaid === true || u.subscriptionStatus === 'active' || u.subscriptionStatus === 'Active'
          ).length;

          // Get existing Affiliates doc to preserve balances
          const affRef = doc(db, 'Affiliates', owner.id);
          const affSnap = await getDoc(affRef);
          const existing = affSnap.exists() ? affSnap.data() : {};

          const expectedTotalEarned = activeReferrals * 25;

          logLine(`  üë§ ${owner.Username || owner.id} (${code}): ${totalReferrals} referred, ${activeReferrals} active ‚Üí should earn ¬£${expectedTotalEarned}`);

          if (affSnap.exists()) {
            // Update counts ‚Äî preserve financial balances (don't overwrite real money fields)
            batch2.update(affRef, {
              activeReferrals,
              totalReferrals,
              referralCode: code,
              lastSynced: serverTimestamp()
            });
            logLine(`    ‚Üí Updated existing Affiliates doc (preserved balances)`);
          } else {
            // Create fresh doc if missing ‚Äî put earned amount into pendingBalance
            // (admin must release it to availableBalance via the Release button)
            batch2.set(affRef, {
              userId: owner.id,
              referralCode: code,
              activeReferrals,
              totalReferrals,
              availableBalance: 0,
              pendingBalance: expectedTotalEarned,
              totalEarned: expectedTotalEarned,
              totalWithdrawn: 0,
              createdAt: serverTimestamp(),
              lastSynced: serverTimestamp()
            });
            logLine(`    ‚Üí Created NEW Affiliates doc with ¬£${expectedTotalEarned} in pending (use Release button to make available)`);
          }
          rebuilt++;
        }

        if (rebuilt > 0) {
          await batch2.commit();
          logLine(`\n‚úÖ Rebuilt/updated ${rebuilt} Affiliates docs`);
        }

        logLine('\nüéâ Repair complete! Refreshing data...');
        btn.textContent = '‚úÖ Done!';

        await loadStats();
        await loadAffiliates();

        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'üîß Scan & Repair Referral Data';
        }, 3000);

      } catch (err) {
        logLine(`\n‚ùå Error: ${err.message}`);
        console.error('Repair error:', err);
        btn.disabled = false;
        btn.textContent = 'üîß Scan & Repair Referral Data';
      }
    });
  </script>
</body>
</html>
