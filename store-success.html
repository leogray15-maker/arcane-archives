<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Success | The Arcane Archives</title>
  <link rel="icon" href="ArcaneA.png" />
  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #111827, #02010a 60%, #000);
      color:#e5e5e5;
      min-height:100vh;
      margin:0;
      padding:2rem 1rem 4rem;
    }
    .wrap{ max-width:980px; margin:0 auto; }
    .card{
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px;
      padding:1.2rem;
      margin-bottom:1rem;
    }
    .hero{
      padding:1.5rem;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.25);
      background: radial-gradient(circle at top, rgba(147,51,234,.16), rgba(15,23,42,.96));
      margin-bottom:1rem;
    }
    h1{ margin:0 0 .5rem; font-size:1.6rem; }
    .muted{ color:#9ca3af; line-height:1.5; }
    .pillrow{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.9rem; }
    .pill{
      font-size:.8rem;
      padding:.35rem .6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background: rgba(0,0,0,.25);
      color:#e5e5e5;
      font-weight:800;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:1rem;
    }
    .kv .k{ color:#a78bfa; font-weight:900; letter-spacing:.08em; text-transform:uppercase; font-size:.75rem; }
    .kv .v{ margin-top:.25rem; font-weight:900; }
    .items .item{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      padding:.8rem .9rem;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(0,0,0,.22);
      margin-bottom:.7rem;
    }
    .items .name{ font-weight:900; }
    .items .meta{ color:#9ca3af; font-size:.85rem; margin-top:.15rem; }
    .error{
      background: rgba(239,68,68,.1);
      border:1px solid rgba(239,68,68,.35);
      padding:1rem;
      border-radius:14px;
      line-height:1.6;
    }
    .btnrow{ display:flex; flex-wrap:wrap; gap:.75rem; margin-top:1rem; }
    a.btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.75rem 1rem;
      border-radius:999px;
      font-weight:900;
      text-decoration:none;
      color:#fff;
      border:1px solid rgba(148,163,184,.25);
      background: rgba(0,0,0,.25);
    }
    a.btn.primary{
      background: linear-gradient(135deg, #9333ea, #7e22ce);
      border-color: rgba(167,139,250,.35);
    }
    @media(max-width:760px){
      .grid{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="state" class="card">Loading‚Ä¶</div>

    <div id="content" style="display:none;">
      <div class="hero">
        <h1>‚úÖ Order Confirmed</h1>
        <div class="muted">Your order is saved and will appear in your orders list.</div>

        <div class="pillrow">
          <div class="pill" id="sessionPill">Order: ‚Äî</div>
          <div class="pill" id="emailPill">Email: ‚Äî</div>
          <div class="pill" id="sourcePill">Source: ‚Äî</div>
        </div>

        <div class="btnrow">
          <a class="btn primary" href="dashboard.html">‚Üê Back to Dashboard</a>
          <a class="btn" href="arcane-store.html">üõçÔ∏è Continue Shopping</a>
          <a class="btn" href="store-orders.html">üì¶ View Orders</a>
        </div>
      </div>

      <div class="grid">
        <div class="card kv">
          <div class="k">Status</div>
          <div class="v" id="status">‚Äî</div>
        </div>
        <div class="card kv">
          <div class="k">Total</div>
          <div class="v"><span id="total">‚Äî</span> <span class="muted" id="currency">‚Äî</span></div>
        </div>
        <div class="card kv">
          <div class="k">Order ID</div>
          <div class="v" id="sessionIdText">‚Äî</div>
        </div>
        <div class="card kv">
          <div class="k">Shipping</div>
          <div class="v muted" id="shipping">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="kv">
          <div class="k">Items</div>
        </div>
        <div class="items" id="items"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAK9MheMvSeOpscic4lXUsIwa0J5ubVf6w",
    authDomain: "arcane-archives-3b0f5.firebaseapp.com",
    projectId: "arcane-archives-3b0f5",
    storageBucket: "arcane-archives-3b0f5.firebasestorage.app",
    messagingSenderId: "264237235055",
    appId: "1:264237235055:web:4a2e5605b0ffb5307f069a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function money(n){
    const x = Number(n||0);
    return x.toFixed(2);
  }

  function setState(html){
    const el = document.getElementById('state');
    el.innerHTML = html;
    el.style.display = 'block';
    document.getElementById('content').style.display = 'none';
  }

  function showContent(){
    document.getElementById('state').style.display = 'none';
    document.getElementById('content').style.display = 'block';
  }

  function fmtShipping(addr){
    if (!addr) return '‚Äî';
    const parts = [addr.line1, addr.line2, addr.city, addr.state, addr.postal_code, addr.country].filter(Boolean);
    return parts.length ? parts.map(escapeHtml).join('<br>') : '‚Äî';
  }

  function renderItems(items){
    const wrap = document.getElementById('items');
    if (!Array.isArray(items) || items.length === 0){
      wrap.innerHTML = `<div class="muted">No items found on this order.</div>`;
      return;
    }

    wrap.innerHTML = items.map(it => {
      const name = it.name || 'Item';
      const qty = Number(it.qty || 1);
      const color = it.color ? `Colour: ${it.color}` : '';
      const meta = [color, `Qty: ${qty}`].filter(Boolean).join(' ‚Ä¢ ');
      return `
        <div class="item">
          <div>
            <div class="name">${escapeHtml(name)}</div>
            <div class="meta">${escapeHtml(meta)}</div>
          </div>
          <div class="pill">${escapeHtml(it.productId || '')}</div>
        </div>
      `;
    }).join('');
  }

  function clearCartOnce(){
    try{ localStorage.removeItem("arcane_cart"); }catch{}
    try{ localStorage.removeItem("arcane_store_basket"); }catch{}
  }

  function setPills(order, id){
    document.getElementById('sessionPill').textContent = `Order: ${id || '‚Äî'}`;
    document.getElementById('sessionIdText').textContent = id || '‚Äî';
    document.getElementById('emailPill').textContent = `Email: ${order.userEmail || '‚Äî'}`;
    document.getElementById('sourcePill').textContent = `Source: ${order.source || '‚Äî'}`;
  }

  function render(order, id){
    setPills(order, id);
    document.getElementById('status').textContent = String(order.orderStatus || 'pending').toUpperCase();
    document.getElementById('total').textContent = money(order.amountTotal || 0);
    document.getElementById('currency').textContent = String(order.currency || 'usd').toUpperCase();
    document.getElementById('shipping').innerHTML = fmtShipping(order.shippingAddress);
    renderItems(order.items || []);
    clearCartOnce();
    showContent();
  }

  const params = new URLSearchParams(location.search);
  const sessionId = params.get('session_id');
  const orderId = params.get('order_id');

  if (!orderId && !sessionId){
    setState(`<div class="error">Missing <b>order_id</b> or <b>session_id</b> in the URL.</div>`);
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user){
      const returnTo = encodeURIComponent(location.pathname + location.search);
      location.href = `login.html?returnTo=${returnTo}`;
      return;
    }

    if (!orderId && !sessionId) return;

    try{
      setState('Loading your order...');
      const ref = doc(db, 'Orders', orderId || sessionId);
      const snap = await getDoc(ref);

      if (!snap.exists()){
        setState(`
          <div class="error">
            We couldn‚Äôt find your order yet.<br>
            Sometimes the webhook takes a few seconds.<br><br>
            Try refreshing in a moment.<br>
            <div style="margin-top:0.5rem; font-weight:900;">Order: ${escapeHtml(orderId || sessionId)}</div>
          </div>
        `);
        return;
      }

      const order = snap.data();

      // Safety: order must belong to this user
      if (order.userId && order.userId !== user.uid){
        setState(`<div class="error">This order doesn‚Äôt belong to your account.</div>`);
        return;
      }

      render(order, orderId || sessionId);
    }catch(err){
      console.error(err);
      setState(`<div class="error">Failed to load order.</div>`);
    }
  });
</script>
</body>
</html>
